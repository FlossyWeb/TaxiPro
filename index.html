<!doctype html>
<html>
    <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="CONTENT-LANGUAGE" content="French">
    <title>Mon Appli Taxi Pro by TaxiMedia</title>
    <link rel="apple-touch-icon" href="visuels/idev.favicon.png"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <!-- <meta name="viewport" content="width=device-width, height=device-height, user-scalable=yes, initial-scale=1"/> -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-startup-image" href="visuels/startup_image.png" />
    <!-- iPhone -->
    <link rel="apple-touch-startup-image" media="(device-width: 320px)" href="visuels/startup_image.png">
    <!-- iPhone (Retina) -->
    <link rel="apple-touch-startup-image"
          media="(device-width: 320px)
             and (-webkit-device-pixel-ratio: 2)"
          href="visuels/startup_image_xl.png">
    <!-- iPhone 5 -->
    <link rel="apple-touch-startup-image"
            media="(device-width: 320px) and (device-height: 568px)
            and (-webkit-device-pixel-ratio: 2)"
            href="visuels/startup_image_i5.png">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />
	<link rel="stylesheet" href="css/themes/monTaxiPro.min.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
    <link type="text/css" rel="stylesheet" href="css/jqm-datebox-1.4.5.min.css" />
    <link type="text/css" rel="stylesheet" href="css/dcvpad.css" />
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script type="text/javascript">
        $( document ).on( "mobileinit", function() {
            // Make your jQuery Mobile framework configuration changes here!
            $.support.cors = true;
            $.mobile.allowCrossDomainPages = true;
            $.mobile.selectmenu.prototype.options.nativeMenu = false;
			//$.mobile.ajaxEnabled = false;
			$.mobile.loader.prototype.options.text = "Veuillez patienter pendant le chargement. Merci de votre confiance !";
			$.mobile.loader.prototype.options.textVisible = "true";
			$.mobile.loader.prototype.options.theme = "a";
			$.mobile.loader.prototype.options.html = '<span class="ui-bar ui-overlay-a ui-corner-all"><center><img src="visuels/preload.gif"/><br><span style="color:#F00;">Veuillez patienter pendant le chargement</span><br>Merci de votre confiance !</center></span>';
        });
    </script>    
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="phonegap.js"></script>
    <script src="barcodescanner.js"></script>
    <script src="contactNumberPicker.js"></script>
    <script src="sms.js"></script>
    <!-- <script src="PowerManagement.js"></script> -->
    <script type="text/javascript" src="js/jquery.html5storage.min.js"></script>
    <script type="text/javascript" src="js/jsimple-star-rating.min.js"></script>
    <script type="text/javascript" src="js/jqm-datebox-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/jqm-datebox-fr-formats.js"></script>
    <script src="https://maps.google.com/maps/api/js?key=AIzaSyCvL4a4-LKLUXJrTwpJ4_UnkmtZSGgrVWg&sensor=false&libraries=places" type="text/javascript"></script>
	<!-- <script type="text/javascript" src="js/jquery.geocomplete.min.js"></script> -->
	<script type="text/javascript" src="ui/min/jquery.ui.map.full.min.js"></script>
    <script type="text/javascript">	
    //<![CDATA[
    var map;
    var markers = [];
    var infoWindow;
    var locationSelect;
	var idcourse = '';
	var dep = '';
	var zip = '';
	var insee = '';
	var time;
	var endcourse; // Clears the timeout
	var regName1 = $.localStorage.getItem('regName1');
	var regCell1 = $.localStorage.getItem('regCell1');
	var regName2 = $.localStorage.getItem('regName2');
	var regCell2 = $.localStorage.getItem('regCell2');
	var regName3 = $.localStorage.getItem('regName3');
	var regCell3 = $.localStorage.getItem('regCell3');
	var registeredUser = $.localStorage.getItem('registeredUser');
	var firstConnexionVar = $.localStorage.getItem('firstConnexionVar');
	var company = $.localStorage.getItem('company');
	var nom = $.localStorage.getItem('nom');
	var tel = $.localStorage.getItem('tel');
	var email = $.localStorage.getItem('email');
	var operator = $.localStorage.getItem('operator');
	var dontReg = false;
	var mobileMap = { 'center': '47.2, 2.5', 'zoom': 6 };
	var isPlaceChanged = true; // Assuming geolocation will get zip unless address is tipped at last
	var zipChecked = false;
	var hail_id = "";
	var taxi_phone_number;
	var lat = 0;
	var lng = 0;
	var badgeNumber = 1;
	var toNotify;
	var answerBoxOpenPoped=0;
	var stopCheckAnswer=false;
	var refreshOpenMarkers;
	var markerCab;
	var countMarkerCab;
	var notifyOnce = true;

	// Scanner
	var scanner;
	// Detect wether it is an App or WebApp
	var app;

	////////////////////////////////////////////////////////////
	
	// Checks App or Browser
	app = document.URL.indexOf( 'http://' ) === -1 && document.URL.indexOf( 'https://' ) === -1 && document.URL.indexOf("localhost") != 7;
	if ( app ) {
		// PhoneGap application
		// Attendre que PhoneGap soit prêt	    //
		document.addEventListener("deviceready", onDeviceReady, false);
	
		// PhoneGap est prêt
		function onDeviceReady() {
			document.addEventListener("backbutton", onBackKeyDown, false);
			document.addEventListener("resume", onResume, false);
			//document.addEventListener("menubutton", onMenuKeyDown, false);
			StatusBar.overlaysWebView(false);
			StatusBar.backgroundColorByHexString("#99808E");
			// prevent device from sleeping
			window.powermanagement.acquire();
			if(($.localStorage.getItem('registeredUser') != 1) && ($.localStorage.getItem('registeredUser') != 'OK'))
			{
				//navigator.notification.alert("Valeur du Registre: "+$.localStorage.getItem('registeredUser'), alertDismissed, 'Mon Appli Taxi', 'OK');
				$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
			}
			else {
				$.post("https://www.mytaxiserver.com/taxioffsrv/blacklist.php", { userid: operator, tel: tel}, function(data) {
					if (data.banned == 1)
					{
						$.mobile.pageContainer.pagecontainer("change", "#subscription", { transition: "slide"} );
						var displayThis = '<p style="color:red;"><b>Votre compte &agrave; &eacute;t&eacute; banni pour cause d&rsquo;utilisation abusive, d&eacute;sol&eacute;.<br>Vous pouvez nous contacter pour toute r&eacute;clamation: </b></p><center><a href="mailto:info@taximedia.fr" class="ui-btn ui-btn-icon-left ui-icon-mail ui-shadow-icon ui-corner-all">Courriel</a><a href="tel:0491034263" class="ui-btn ui-btn-icon-left ui-icon-phone ui-btn-inline">T&eacute;l&eacute;phone</a></center>';
						$("#subReturns").empty().append(displayThis);
					}
					/*
					if(data.phone_ok != 'OK') {
						$.localStorage.setItem('registeredUser', 'KO');
						$.localStorage.setItem('firstConnexionVar', 'YES');
						$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
						var displayThis = '<p style="color:red;"><b>Le numéro de téléphone associé à votre compte doit être validé.<br>Vous pouvez vous connecter en utilisant vos identifiants ou vérifier votre numéro ci-dessus.</b></p>';
						$("#fogotReturns").empty().append(displayThis);
					}
					*/
				}, "json");
			}
			if((navigator.network.connection.type == Connection.NONE) || !window.jQuery){
				$("body").empty().append('<img src="no_network.png" width="'+screen.width+'" height="'+screen.height+'" onClick="window.location.reload()" />');
			}
			locateMe();
			scanner = cordova.require("cordova/plugin/BarcodeScanner");
			// For Android => Enable background mode
			cordova.plugins.backgroundMode.enable();
			cordova.plugins.backgroundMode.setDefaults({
				title:  'App toujours en fonction (3 MINUTES MAX)',
				ticker: 'App toujours en fonction (3 MINUTES MAX)',
				text:   'Nous vous informons des courses en cours...'
			});
			// For iOS => backgroundtask
			//backgroundtask.start(bgFunctionToRun);
			cordova.plugins.notification.local.clearAll(function() {
				//alert("All notifications cleared");
			}, this);
		}
		// GESTION DES BOUTONS MATERIEL
		// Bouton retour
		function onBackKeyDown() {
			//history.back();
			//changePage('#infos');
			navigator.notification.alert("Veuillez ne pas quitter Mon Appli Taxi pendant la recheche de taxi disponibles", alertDismissed, 'Mon Appli Taxi', 'OK');
		}
		function onResume() {
			setTimeout(function() {
				if((navigator.network.connection.type == Connection.NONE) || !window.jQuery){
					$("body").empty().append('<img src="no_network.png" width="'+screen.width+'" height="'+screen.height+'" onClick="window.location.reload()" />');
				}
			}, 500);// iOS Quirks
		}
		function bgFunctionToRun() {
			if(hail_id!="") check_answer_open();
			if(idcourse!="") check_answer();
		}
		// Bouton menu
		//function onMenuKeyDown() {}
	}
	else {
		app = false;
		$(window).on('beforeunload', function(e) {
			if(idcourse!='') {
				stopCall();
				return "SI VOUS AVIEZ UNE COMMANDE EN COURS ELLE EST ANNULEE ! (CELA NE S'APPLIQUE PAS AUX RESERVATIONS)";
			}
		});
	}
	$.urlParam = function(name, url){
		// Get parameters from an URL
		var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(url);
		//For current URL
		//var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
		if (results==null){
		   return null;
		}
		else{
		   return results[1] || 0;
		}
	}
	// Get params from url when called from url the scheme...
	function handleOpenURL(url) {
		setTimeout(function() {
			//alert("received url: " + url);
			fromApp = $.urlParam('from', url); // AppName
			toApp = $.urlParam('to', url); // PageToGo
			if(fromApp=='driver') {
				$('#getBackDriver').append('<a href="montaxidriver://" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back">Retour app chauffeur</a>');
			}
			if(toApp=='history') {
				//alert(toApp);
				$.mobile.pageContainer.pagecontainer("change", "#"+toApp, { transition: "slide"} );
			}
		}, 600);
	}
	var scanSuccess = function (result) {
		var textFormats = "QR_CODE DATA_MATRIX";
		var productFormats = "UPC_E UPC_A EAN_8 EAN_13";
		if (result.cancelled) { return; }
		if (textFormats.match(result.format)) {                
			var scanVal = result.text;
			if (scanVal.indexOf("http") === 0) {
				setTimeout(function() { 
					//window.plugins.childBrowser.showWebPage(result.text, { showLocationBar: true }); 
					window.open(result.text,'_blank','location=yes,enableViewportScale=yes,closebuttoncaption=Fermer');
				}, 500);
			} else {
				navigator.notification.alert(
						result.text,
						function (){},
						'Scan Value:',
						'Done'
					);
			}
		} else if (productFormats.match(result.format)) {
			var searchUrl = "https://www.google.fr/#q=" + result.text;
			setTimeout(function() { 
				//window.plugins.childBrowser.showWebPage(searchUrl, { showLocationBar: true });
				window.open(searchUrl,'_blank','location=yes,enableViewportScale=yes,closebuttoncaption=Fermer');
			}, 500);
		} else { navigator.notification.alert("Format du scan: " + result.format + 
				  " NON SUPPORTE. Valeur du scan: " + result.text);
		}
	}
	function goScan ()
	{
		if (app) {
			// If app is runing we scan from the device camera
			scanner.scan(
				scanSuccess, 
				function (error) {
					navigator.notification.alert("Scan Erreur: " + error);
				}
			);
		}
		else {
			$('#smsReturn').empty().append('Cette fonction n&rsquo;est disponible que sur l&rsquo;application mobile');
			$( "#popSms" ).popup( "open", { positionTo: "window" } );
			//navigator.notification.alert('WTF');
		}
	}

	function Share()
	{
		var successCallbackPick = function(result){
			setTimeout(function(){
				//navigator.notification.alert(result.name + " " + result.phoneNumber);
				var number = result.phoneNumber;
				var message = "Téléchargez l'app Mon Appli Taxi Pro en suivant ce lien : http://www.taximedia.fr/stores.php?app=taxipro";
				var intent = ""; //leave empty for sending sms using default intent
				var smsSuccess = function () {
					//navigator.notification.alert('Message sent successfully');
					$('#smsReturn').empty().append('Message envoy&eacute; avec succ&egrave;s, Merci');
					$( "#popSms" ).popup( "open", { positionTo: "window" } );
				};
				var smsError = function (e) {
					//navigator.notification.alert('Message Failed:' + e); 
					$('#smsReturn').empty().append('Probl&egrave;me lors de l&rsquo;envoi du message: ' + e);
					$( "#popSms" ).popup( "open", { positionTo: "window" } );
				};
				sms.send(number, message, intent, smsSuccess, smsError);
			},500);
		};
		var failedCallbackPick = function(result){
			setTimeout(function(){
				//navigator.notification.alert(result);
			},500);
		}
		if (app) {
			// If app is runing we get contact from the device
			window.plugins.contactNumberPicker.pick(successCallbackPick,failedCallbackPick);
		}
		else {
			$('#smsReturn').empty().append('Cette fonction n&rsquo;est disponible que sur l&rsquo;application mobile');
			$( "#popSms" ).popup( "open", { positionTo: "window" } );
			//navigator.notification.alert('WTF');
		}
	}
	
	function getContact()
	{
		var successCallbackPick = function(result){
			setTimeout(function(){
				//navigator.notification.alert(result.name + " " + result.phoneNumber);
				var nameContact = result.name;
				var number = result.phoneNumber;
				var currentName = $('#Accurate').val();
				$('#Accurate').val(nameContact);
				$('#cellular').val(number);
				$("#next-box").hide("fast");
				$("#search-box").show("medium");
			},500);
		};
		var failedCallbackPick = function(result){
			setTimeout(function(){
				//navigator.notification.alert(result);
			},500);
		}
		if (app) {
			// If app is runing we get contact from the device
			window.plugins.contactNumberPicker.pick(successCallbackPick,failedCallbackPick);
		}
		else {
			//navigator.notification.alert(nom+' - '+mngid+' - '+tel);
			$.post("https://www.mytaxiserver.com/appserver/get_contacts.php", {dep: dep, tel: tel}, function(data) {
				$('#contReturn').empty().append(data);
				$( "#popCont" ).popup( "open", { positionTo: "window" } );
			});
		}
	}
	
	function dc() {
		$.localStorage.setItem('registeredUser', 'KO');
		$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
	}
	function login() {
		var id = $('#login').val();
		var pwd = $('#pwd').val();
		$.post("https://www.mytaxiserver.com/taxioffsrv/login_app.php", { id: id, pwd: pwd, kinda: 'pro', first: $.localStorage.getItem('firstConnexionVar')}, function(data) {
			$.localStorage.setItem('nom', data.nom);
			$.localStorage.setItem('company', data.nom); // here name = company name
			$.localStorage.setItem('email', data.email);
			$.localStorage.setItem('tel', data.tel);
			$.localStorage.setItem('operator', data.operator);
			// Refresh Script Vars
			nom = data.nom;
			company = data.nom;
			tel = data.tel;
			email = data.email;
			operator = data.operator;
			if (!data.pass)
			{
				display = '<p style="color:red;"><b>Les identifiant et mot de passe fournis ne sont pas corrects.</b></p>';
				$("#loginReturns").empty().append(display);
			}
			else
			{ // IDENTIFIED SO GETS IN...
				$('#Accurate').val(data.nom);
				$('#cellular').val(data.tel);
				$.localStorage.setItem('registeredUser', 'OK');
				$.localStorage.setItem('firstConnexionVar', 'NO');
				$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
			}
		}, "json");
	}
	function subscribe() {
		$.mobile.loading( "show" );
		nom = $('#subName').val();
		tel = $('#subTel').val();
		email = $('#subMail').val();
		$("#subReturns").empty();
		$.post("https://www.mytaxiserver.com/taxioffsrv/register_app.php", { nom: nom, tel: tel, email: email, kinda: 'pro'}, function(data) {
			$.localStorage.setItem('nom', data.nom);
			$.localStorage.setItem('company', data.nom); // here name = company name
			$.localStorage.setItem('email', data.email);
			$.localStorage.setItem('tel', data.tel);
			$.localStorage.setItem('operator', data.operator);
			// Refresh Script Vars
			nom = data.nom;
			company = data.nom;
			tel = data.tel;
			email = data.email;
			operator = data.operator;
			if (data.subscribed === true)
			{
				//navigator.notification.alert(data.subscribed+' '+data.telexist+' '+data.telvalid+' '+data.emailvalid);
				//$.localStorage.setItem('registeredUser', 'OK');
				//if ($.localStorage.getItem('firstConnexionVar') != 'NO') $.localStorage.setItem('firstConnexionVar', 'YES');
				$('#Accurate').val(data.nom);
				$('#cellular').val(data.tel);
				$('#login').val(data.tel);
				//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
				/*
				if(data.sms=='1') {
					if(app) navigator.notification.alert('Afin de vérifier votre numéro de mobile vous allez recevoir vos identifiants par sms, nous vous remercions pour votre inscription.', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Afin de vérifier votre numéro de mobile vous allez recevoir vos identifiants par sms, nous vous remercions pour votre inscription.');
				}
				else {
					if(app) navigator.notification.alert("Pour une raison technique ou parce que votre numéro de téléphone a généré trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr", alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert("Pour une raison technique ou parce que votre numéro de téléphone a généré trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr");
				}
				*/
				if(app) navigator.notification.alert('Afin de vérifier votre email vous allez recevoir vos identifiants à l\'adresse communiquée, si vous ne recevez rien pensez à regarder dans les spams et en cas de problème nous vous invitons à nous contacter par email ou téléphone. Nous vous remercions pour votre inscription.', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Afin de vérifier votre email vous allez recevoir vos identifiants à l\'adresse communiquée, si vous ne recevez rien pensez à regarder dans les spams et en cas de problème nous vous invitons à nous contacter par email ou téléphone. Nous vous remercions pour votre inscription.');
				$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
			}
			else {
				display = '<p><b>Vous n&rsquo;avez pas correctement rempli le formulaire d&rsquo;inscription. Nous vous prions de modifier les informations suivantes.</b></p><br>';
				
				if (data.telexist === true)
				{
					display += '<p style="color:red;"><b>Le num&eacute;ro de t&eacute;l&eacute;phone fourni est d&eacute;j&agrave; associ&eacute; &agrave; un compte.</b></p>';
				}
				if (data.telvalid === false)
				{
					display += '<p style="color:red;"><b>Le num&eacute;ro de t&eacute;l&eacute;phone fourni n&rsquo;est pas valide: 0000000000 (sans espaces).</b></p>';
				}
				if (data.emailvalid === false)
				{
					display += '<p style="color:red;"><b>L&rsquo;email fourni n&rsquo;est pas valide.</b></p>';
				}
			}
			$("#subReturns").empty().append(display);
		}, "json").always(function(data) {
			$.mobile.loading( "hide" );
		});
	}
	function accountMod() {
		$.mobile.loading( "show" );
		tel = $.localStorage.getItem('tel');
		nom = $('#accName').val();
		newtel = $('#accTel').val();
		email = $('#accMail').val();
		pwd = $('#accPwd').val();
		$("#accReturns").empty();
		$.post("https://www.mytaxiserver.com/taxioffsrv/modmy_app.php", { nom: nom, tel: tel, newtel: newtel, email: email, pwd: pwd, kinda: 'pro', operator: operator}, function(data) {
			if (data.modmy == 1)
			{
				$.localStorage.setItem('nom', data.nom);
				$.localStorage.setItem('company', data.nom); // here name = company name
				$.localStorage.setItem('email', data.email);
				$.localStorage.setItem('tel', data.tel);
				// Refresh Script Vars
				nom = data.nom;
				company = data.nom;
				tel = data.tel;
				email = data.email;
				display = '<p style="color:green;"><b>Vous avez bien modifi&eacute; votre compte.</b></p><br>';
				/*
				if(data.check_again == 'YES') {
					if(data.sms=='1') {
						if(app) navigator.notification.alert('Vous avez bien modifié votre compte. Afin de re-vérifier votre numéro de mobile vous allez recevoir vos nouveaux identifiants par sms et devrez vous reconnectez avec, nous vous remercions pour votre inscription.', alertDismissed, 'Mon Appli Taxi', 'OK');
						else alert('Vous avez bien modifié votre compte. Afin de re-vérifier votre numéro de mobile vous allez recevoir vos nouveaux identifiants par sms et devrez vous reconnectez avec, nous vous remercions pour votre inscription.');
					}
					else {
						if(app) navigator.notification.alert("Vous avez bien modifié votre compte. Mais pour une raison technique ou parce que votre nouveau numéro de téléphone a générer trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr", alertDismissed, 'Mon Appli Taxi', 'OK');
						else alert("Vous avez bien modifié votre compte. Mais pour une raison technique ou parce que votre nouveau numéro de téléphone a générer trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr");
					}
					$.localStorage.setItem('registeredUser', 'KO');
					$.localStorage.setItem('firstConnexionVar', 'YES');
					$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
				}
				*/
			}
			else {
				display = '<p style="color:red;"><b>Vous n&rsquo;avez pas modifi&eacute; votre compte.</b></p><br>';
				
				if (data.telvalid === false)
				{
					display += '<p style="color:red;"><b>Le num&eacute;ro de t&eacute;l&eacute;phone fourni n&rsquo;est pas valide: 0000000000 (sans espaces).</b></p>';
				}
				if (data.emailvalid === false)
				{
					display += '<p style="color:red;"><b>L&rsquo;email fourni n&rsquo;est pas valide.</b></p>';
				}
				if (data.verif=='' && data.modmy == '0')
				{
					display += '<p style="color:red;"><b>Le t&eacute;l&eacute;phone renseign&eacute; n&rsquo;est associ&eacute; &agrave; aucun compte.</b></p>';
				}
				if (data.verif==-1)
				{
					display += '<p style="color:red;"><b>Le t&eacute;l&eacute;phone renseign&eacute; est d&eacute;j&agrave; associ&eacute; &agrave; un autre compte. Veuillez nous contacter via contact@taximedia.fr</b></p>';
				}
			}
			$("#accReturns").empty().append(display);
		}, "json").always(function(data) {
			$.mobile.loading( "hide" );
		});
	}
	function reSendText() {
		$.mobile.loading( "show" );
		$.post("https://www.mytaxiserver.com/taxioffsrv/sendtext.php", { tel: $('#smsTel').val(), kinda: 'pro'}, function(data) {
			if (data.valid_check=='KO') {
				if (data.sms=='1') {
					if(app) navigator.notification.alert('Afin de vérifier votre numéro de mobile vous allez recevoir vos identifiants par sms, nous vous remercions pour votre inscription.', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Afin de vérifier votre numéro de mobile vous allez recevoir vos identifiants par sms, nous vous remercions pour votre inscription.');
				}
				else {
					//if(app) navigator.notification.alert("Pour une raison technique ou parce que votre numéro de téléphone a générer trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr", alertDismissed, 'Mon Appli Taxi', 'OK');
					//else alert("Pour une raison technique ou parce que votre numéro de téléphone a générer trop d'envois de sms, nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr");
					if(app) navigator.notification.alert("Pour une raison technique nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr", alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert("Pour une raison technique nous ne pouvons valider votre compte. Veuillez nous contacter via contact@taximedia.fr");
				}
			}
			else if (data.valid_check=='OK') {
				if(app) navigator.notification.alert('Ce numéro de téléphone a déjà été validé, vous devriez pouvoir vous connecter.', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Ce numéro de téléphone a déjà été validé, vous devriez pouvoir vous connecter.');
			}
			else {
				if(app) navigator.notification.alert("Ce numéro de téléphone n'est probablement associé à aucun compte !!", alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert("Ce numéro de téléphone n'est probablement associé à aucun compte !!");
			}
			if (data.telvalid === false)
			{
				if(app) navigator.notification.alert("Ce numéro de téléphone fourni n'est pas valide: nous attendons 10 chiffres sans espaces et commençant par 06 ou 07.", alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert("Ce numéro de téléphone fourni n'est pas valide: nous attendons 10 chiffres sans espaces et commençant par 06 ou 07.");
			}
		}, "json").always(function(data) {
			$('#reSendTextForm').slideToggle();
			$.mobile.loading( "hide" );
		});
	}
	function forgottenPwd() {
		$.mobile.loading( "show" );
		var login = $('#forgotTel').val();
		var mail = $('#forgotMail').val();
		$.post("https://www.mytaxiserver.com/taxioffsrv/forget_app.php", { login: login, mail: mail, kinda: 'pro'}, function(data) {
			var display = '';
			if (data.sent)
			{
				display = '<p><b>Voici les informations d&rsquo;identification qui vous permettront d&rsquo;acc&egrave;der &agrave; votre compte :<br><span style="color:#09F;">Identifiant = ' + data.tel + '<br>Mot de passe = ' + data.pwd + '</span><br>Vous les recevrez dans quelques instants &agrave; cet email : <span style="color:#09F;">' + data.email + '</span>, merci.<br></b></p>';
			}
			/*
			else if (data.phone_ok!='OK') {
				display += '<p style="color:red;"><b>Nous ne pouvons divulguer vos informations personnelles car le num&eacute;ro de t&eacute;l&eacute;phone fourni n&rsquo;a pas &eacute;t&eacute; valid&eacute;.</b></p>';
			}
			*/
			else {
				display += '<p style="color:red;"><b>Nous ne pouvons divulguer vos informations personnelles car l&rsquo;identifiant ou l&rsquo;adresse mail fourni ne figure pas dans notre base de donn&eacute;e.</b></p>' + data.tel + ' - ' + data.email;
			}
			$("#fogotReturns").empty().append(display);
		}, "json").always(function(data) {
			$('#forgotForm').slideToggle();
			$.mobile.loading( "hide" );
		});
	}
	function alertDismissed()
	{
		// Do Nothing...
	}
	function openSomeUrl(url)
	{
		//window.plugins.childBrowser.showWebPage('http://www.taximedia.fr/redir.php', { showLocationBar: true });
		window.open(url,'_blank','location=false,enableViewportScale=yes,scrollbars=yes,closebuttoncaption=Fermer');
	}
	$(document).on( 'pagecreate', function() {
		$( "body>[data-role='panel']" ).panel().enhanceWithin();
		$.localStorage.setItem('firstConnexionVar', 'NO');
	});
	$( '#connect' ).live( 'pagecreate',function(event){
		$('#displayForgot').click(function (){
			$('#forgotForm').slideToggle();
		});
		$('#displayReSendText').click(function (){
			$('#reSendTextForm').slideToggle();
		});
		$('#forgotTel').val(tel);
		$('#smsTel').val(tel);
	});
	$( '#account' ).live( 'pagecreate',function(event){
		nom = $.localStorage.getItem('nom');
		tel = $.localStorage.getItem('tel');
		email = $.localStorage.getItem('email');
		$('#accName').val(nom);
		$('#accMail').val(email);
		$('#accTel').val(tel);
	});
	function more(n) {
		$('#histBlock'+n).slideToggle('slow', function() {
			// Animation complete.
			if($('#histBlock'+n).css("display")=='none') {
				$('#hbtn'+n).removeClass('ui-icon-minus').addClass('ui-icon-plus');
			}
			else {
				$('#hbtn'+n).removeClass('ui-icon-plus').addClass('ui-icon-minus');
			}
		});
	}
	function moreb(n) {
		$('#bookBlock'+n).slideToggle('slow', function() {
			if($('#bookBlock'+n).css("display")=='none') {
				$('#bbtn'+n).removeClass('ui-icon-minus').addClass('ui-icon-plus');
			}
			else {
				$('#bbtn'+n).removeClass('ui-icon-plus').addClass('ui-icon-minus');
			}
		});
	}
	function refreshHist() {
		$.mobile.loading( "show" );
		$.post("https://www.mytaxiserver.com/taxioffsrv/history_v2.php", { tel: tel, pass: 1, dep: dep, operator: operator, hist: 1}, function(data){
			$("#hist_cont").empty().append(data);
		}).always(function() {
			$.post("https://www.mytaxiserver.com/taxioffsrv/history_v2.php", { tel: tel, pass: 1, dep: dep, operator: operator, hist: 0}, function(data){
				$("#book_cont").empty().append(data);
			}).always(function() { $.mobile.loading( "hide" ); });
		});
	}
	function showCont(cont2show, cont2hide) {
		refreshHist();
		if($(window).width()<=1006) {
			// Only hides cont if conts are not both displayed, see css breakpoint
			$(cont2hide).hide();
			$(cont2show).show();
		}
	}
	$( '#history' ).live( 'pagecreate',function(event){
		$.mobile.loading( "show" );
		$.post("https://www.mytaxiserver.com/taxioffsrv/history_v2.php", { tel: tel, pass: 1, dep: dep, operator: operator, hist: 1}, function(data){
			$("#hist_cont").empty().append(data);
		}).always(function() {
			$.post("https://www.mytaxiserver.com/taxioffsrv/history_v2.php", { tel: tel, pass: 1, dep: dep, operator: operator, hist: 0}, function(data){
				$("#book_cont").empty().append(data);
			}).always(function() { $.mobile.loading( "hide" ); });
		});
	});
	function rateCab(rtaxi, ridcourse, rdep, rtel)
	{
		$.sessionStorage.setItem('rtaxi', rtaxi);
		$.sessionStorage.setItem('ridcourse', ridcourse);
		$.sessionStorage.setItem('rdep', rdep);
		$.sessionStorage.setItem('rtel', rtel);
		$.mobile.pageContainer.pagecontainer("change", "#rate_page", { transition: "slide"} );
	}
	function rateCabOpen(rtaxi, ridcourse, rdep, rtel, rhail_id, rrdv)
	{ //\''.$taxi.'\', \''.$idcourse.'\', \''.$dep.'\', \''.$tel.'\', \''.$hail_id.'\', \''.$rdv.'\'
		$.sessionStorage.setItem('rtaxi', rtaxi);
		$.sessionStorage.setItem('rhail_id', rhail_id);
		$.sessionStorage.setItem('rrdv', rrdv);
		$.sessionStorage.setItem('ridcourse', ridcourse);
		$.sessionStorage.setItem('rdep', rdep);
		$.sessionStorage.setItem('rtel', rtel);
		$('#monTaxiRate').hide();
		$('#leTaxiRate').show();
		$.mobile.pageContainer.pagecontainer("change", "#rate_page", { transition: "slide"} );
	}
	$( '#rate_page' ).live( 'pagecreate',function(event){
		var noted = $.sessionStorage.getItem('rtaxi');
		$('#urate').empty().append('Vous notez le taxi '+noted);
		$('#urate2').empty().append('Vous notez le taxi '+noted);
		$(".rating").starRating({
			minus: false // step minus button
		});
		$(".rating2").starRating({
			minus: false // step minus button
		});
		$(".rating3").starRating({
			minus: false // step minus button
		});
		$(".rating4").starRating({
			minus: false // step minus button
		});
		$(".rating5").starRating({
			minus: false // step minus button
		});
		// For openRating there is a comment only if 3 stars or less
		$('#leComRateCont').hide();
		setInterval( function () {
			//var fifthRate = $(".rating5").data("val");
			var fifthRate = document.getElementById("rating5").getAttribute("data-val");
			if (fifthRate < 4 && fifthRate != null) { $('#leComRateCont').show();}
			else $('#leComRateCont').hide();
		}, 1000);
	});
	function rating()
	{
		var rtaxi = $.sessionStorage.getItem('rtaxi');
		var ridcourse = $.sessionStorage.getItem('ridcourse');
		var rdep = $.sessionStorage.getItem('rdep');
		var rtel = $.sessionStorage.getItem('rtel');
		var accueil = $(".rating").data("val");
		var tarif = $(".rating2").data("val");
		var vehicule = $(".rating3").data("val");
		var conduite = $(".rating4").data("val");
		var comRate = $(".comRate").val();
		//navigator.notification.alert(rtaxi+' - '+ridcourse+' - '+rdep+' - '+rtel+' - '+accueil+' - '+tarif+' - '+vehicule+' - '+conduite);
		$.post("https://www.mytaxiserver.com/mytaxisrv/rate.php", { taxi: rtaxi, idcourse: ridcourse, dep: rdep, tel: rtel, accueil: accueil, tarif: tarif, vehicule: vehicule, conduite: conduite, comments: comRate, judge: 1}, function(data){ $('#rateBack').empty().append('Vos notes ont &eacute;t&eacute; prises en compte, Merci.');});
	}
	function ratingOpen()
	{
		var rhail_id = $.sessionStorage.getItem('rhail_id');
		var rrdv = $.sessionStorage.getItem('rrdv');
		var rtaxi = $.sessionStorage.getItem('rtaxi');
		var ridcourse = $.sessionStorage.getItem('ridcourse');
		var rdep = $.sessionStorage.getItem('rdep');
		var rtel = $.sessionStorage.getItem('rtel');
		var giveNote = $(".rating5").data("val");
		var comRate = $("#leComRate").val();
		//navigator.notification.alert(rtaxi+' - '+ridcourse+' - '+rdep+' - '+rtel+' - '+accueil+' - '+tarif+' - '+vehicule+' - '+conduite);
		$.post("https://www.mytaxiserver.com/appclient/open_rate.php", { taxi: rtaxi, idcourse: ridcourse, dep: rdep, tel: rtel, hail_id: rhail_id, giveNote: giveNote, comments: comRate, cell: tel, operator: operator, rdv: rrdv, judge: 1}, function(data){ $('#leRateBack').empty().append('Vos note et commentaire ont &eacute;t&eacute; pris en compte, Merci.');});
	}
	function booking()
	{
		dep = $.sessionStorage.getItem('dep');
		//navigator.notification.alert(dep);
		//if (isPlaceChanged || (dep != '') || (zip != '')) { // Old line changed because we need the zip to be tipped if user tipped the address... To be sure
		if ((isPlaceChanged || zipChecked) && ((dep != '') || (zip != ''))) {
			$('#booking').prop('disabled', true).addClass('ui-disabled'); // If ok disable btn to prevent multiple tap
			var myDate = new Date();
			idcourse = myDate.getTime();
			//$('#dblinks').append($('<input id="idcourse" type="hidden" value="' + idcourse + '"/>'));
			//var radius = document.getElementById('radiusSelect').value;
			company = $.localStorage.getItem('company');
			var rdvpoint = document.getElementById("addressInput").value.replace(/'/g, "&rsquo;");
			var room = document.getElementById("Accurate").value.replace(/'/g, "&rsquo;");
			operator = $.localStorage.getItem('operator');
			var hostname = document.getElementById("hostname").value.replace(/'/g, "&rsquo;");
			var howMany = document.getElementById("howMany").value;
			var typecar = document.getElementById("CarType").value;
			var cb = document.getElementById("Pay").value;
			var group = document.getElementById("group").value;
			switch (cb) {
				case '0':
					var payment = "Non";
					cb = 0;
				  break;
				case '1':
					var payment = "Oui";
					cb = 1;
				  break;
				case '2':
					var payment = "Oui (AMEX)";
					cb = 1;
				  break;
				default:
					var payment = "Non";
					cb = 0;
			}
			var coms = document.getElementById("coms").value.replace(/'/g, "&rsquo;");
			var comments1 = '<ul>' + company + '<li>Nom du client : ' + room + '</li><li>Paiement CB : ' + payment + '</li><li>Nombre de passagers : ' + howMany + '</li><li>Type de vehicule : ' + typecar + '</li>';
			if (coms != '') {
				var comments2 = '<li>' + coms + '</li></ul>';
			}
			else {
				var comments2 = '</ul>';
			}
			var comments = comments1+comments2;
			var dest = document.getElementById("DestAddress").value.replace(/'/g, "&rsquo;");
			var cell = document.getElementById("cellular").value;
			var when = document.getElementById("when").value;
			var date = document.getElementById("date").value;
			//var medic = document.getElementById("medic").value;
			if (!dontReg) {
				for(n=1;n<4;n++) {
					if(($.localStorage.getItem('regName'+n) == null) && ($.localStorage.getItem('regCell'+n) == null)) {
						var regName = $.localStorage.setItem('regName'+n, $('#Accurate').val());
						var regCell = $.localStorage.setItem('regCell'+n, cell);
						var regLast = $.localStorage.setItem('regLast', n);
						var writen = true;
						break;
					}
				}
				if(!writen) {
					var regLast = $.localStorage.getItem('regLast');
					switch (regLast) {
						case '1':
							var entry = 2;
						  break;
						case '2':
							var entry = 3;
						  break;
						case '3':
							var entry = 1;
						  break;
						default:
					}
					var regName = $.localStorage.setItem('regName'+entry, $('#Accurate').val());
					var regCell = $.localStorage.setItem('regCell'+entry, cell);
				}
			}
			var rdvlat = '';
			var rdvlng = '';
			url = '';
			num_req = idcourse;
			dep = $.sessionStorage.getItem('dep');
			url = 'taxi=0000&tel=0000000000&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&howmany=' + howMany + '&dep='+dep + '&zip=' + zip+'&group=1&ack=0&db=1&prix=20000';
			//url = url.replace(/'/g, "&rsquo;"); // if we escape with &rsquo; it will break the url adding a new var &...
			url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
			$.post("https://www.mytaxiserver.com/appserver/bookings_app_share.php", url, function(data) {
				if(!data.ok) {
					//alert('Vous ne pouvez reserver un taxi que si le RDV est dans plus de 60 minutes !!');
					//Sending as direct job
					if(data.past) {
						if(app) navigator.notification.alert('LA DATE DU RDV EST PASSEE !!', alertDismissed, 'Mon Appli Taxi', 'OK');
						else alert('LA DATE DU RDV EST PASSEE !!');
					}
					else {
						checkZip('#map_page_open');
					}
				}
				else {
					$.mobile.pageContainer.pagecontainer("change", "#book_page", { transition: "slide"} );
				}
				$('#booking').prop('disabled', false).removeClass('ui-disabled');
			}, "json");
		}
		else {
			//navigator.notification.alert('No Zip Code Here !!');
			$( "#setZip" ).popup( "open", { positionTo: "window" } );
		}
	}
	$( '#book_page' ).live( 'pagecreate',function(event){
		// NYC-WIFI Animations
		var wc = 1;
		var opacAnim= false;
		var minusAnim= false;
		setInterval( function () {
			if (wc>3) {
				minusAnim = !minusAnim;
			}
			if (minusAnim) wc--;
			else wc++;
			if (wc==0) {
				wc=1;
				minusAnim = !minusAnim;
				opacAnim = !opacAnim;
			}
			var imgPath = "visuels/wifi-"+wc+".png";
			if (opacAnim) $('#animBook #wifiSteps').animate({ opacity: 0 }, 500, function () { $(this).attr("src", imgPath)}).animate({ opacity: 1 }, 500);
			else $('#animBook #wifiSteps').attr("src", imgPath);
        }, 1000);
	});
	function modCmd(recidcourse, recrdv, reccomments, reccell, recwhen, recdep)
	{		
		$('#addressInput2').val(recrdv);
		$('#Accurate2').val(nom);
		$('#cellular2').val(reccell);
		//$('#coms2').text(reccomments);
		$('#date2').val(recwhen);
		$('#modId').val(recidcourse);
		$('#modDep').val(recdep);
		$.mobile.pageContainer.pagecontainer("change", "#modbook", { transition: "slide"} );
	}
	$( '#modbook' ).live( 'pagecreate',function(event){
		$('.expends2').click(function () {
			$(this).next('div').slideToggle('slow');
			//$.mobile.silentScroll($(this).next('div').offset().top);
		});
	});
	function bookingMod()
	{		
		var newAdd = $('#addressInput2').val();
		var newName = $('#Accurate2').val();
		var newCell = $('#cellular2').val();
		var newHowMany = $('#howMany2').val();
		var newType = $('#CarType2').val();
		var newCb = $('#Pay2').val();
		var newWhen = $('#date2').val();
		var newId = $('#modId').val();
		var newDep = $('#modDep').val();
		var payment = "Non";
		if(newCb == 1) {
			payment = "Oui";
		}
		var newComs = document.getElementById("coms2").value.replace(/'/g, "&rsquo;");
		var comments1 = '<ul><li>Nom du client : ' + newName + '</li><li>Paiement CB : ' + payment + '</li><li>Nombre de passagers : ' + newHowMany + '</li><li>Type de vehicule : ' + newType + '</li>';
		if (newComs != '') {
			var comments2 = '<li>' + newComs + '</li></ul>';
		}
		else {
			var comments2 = '</ul>';
		}
		var comments = comments1+comments2;
		url = 'taxi=0000&tel=0000000000&idcourse=' + newId + '&rdvpoint=' + newAdd + '&comments=' + comments + '&cell=' + newCell + '&when=' + newWhen+ '&howmany=' + newHowMany + '&dep=' + newDep+'&db=1';
		//navigator.notification.alert(url);
		url = url.replace(/'/g, "&rsquo;");
		url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
		if(newWhen!='') {
			$.post("https://www.mytaxiserver.com/appserver/bookings_app_mod.php", url, function(data) {
				//$('#resmod').append(data.req);
				if(!data.ok) {
					if(app) navigator.notification.alert('Vous ne pouvez modifier la réservation !!');
					else alert('Vous ne pouvez modifier la réservation !!');
				}
				else {
					$.mobile.pageContainer.pagecontainer("change", "#book_page", { transition: "slide"} );
				}
			}, "json");
		}
		else {
			if(app) navigator.notification.alert('Afin de modifier la réservation, vous devez renseigner une date de RDV !!', alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert('Afin de modifier la réservation, vous devez renseigner une date de RDV !!');
		}
	}
	function delCmd(id, deldep)
	{
		$.post("https://www.mytaxiserver.com/appserver/bookings_app_mod.php", {idcourse: id, dep: deldep, del: 1, db: 1}, function(data) {
			if(!data.ok) {
				if(app) navigator.notification.alert('Vous ne pouvez pas annuler cette réservation !!', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Vous ne pouvez modifier la réservation !!');
			}
			else {
				if(app) navigator.notification.alert('La réservation à bien été annulée !!', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('La réservation à bien été annulée !!');
				refreshHist();
			}
		}, "json");
	}
	/*
	$('#infos').live("swiperight", function() {
		$("#panel_poper").trigger('click');
	});
	*/
	$( '#infos' ).live( 'pagecreate',function(event){
		/*
		$("#addressInput").geocomplete({
		  map: "#map",
		  location: "Montpellier, France"
		});
		*/
		var input = document.getElementById('addressInput');
		var options = {
		  componentRestrictions: {country: 'fr'}
		};
		var autocomplete = new google.maps.places.Autocomplete(input, options);
		// fired when an autocomplete option is selected or the input is submitted
		google.maps.event.addListener(autocomplete, 'place_changed', function() {
			//navigator.notification.alert('Fired');
			isPlaceChanged = true;
			var place = autocomplete.getPlace();
			var address = '';
			var zip_code = '';
			if (place.address_components) {
				address = [
					(place.address_components[0] && place.address_components[0].short_name || ''),
					(place.address_components[1] && place.address_components[1].short_name || ''),
					(place.address_components[2] && place.address_components[2].short_name || '')
				].join(' ');
				for (var i=0; i<place.address_components.length;i++)
				{
					for (var j=0;j<place.address_components[i].types.length;j++)
					{
						if (place.address_components[i].types[j] == "postal_code")
						{
							zip_code = place.address_components[i].long_name;
							zip = zip_code;
							//navigator.notification.alert(zip_code);
							dep = zip_code.substring(0, 2);
							$.sessionStorage.setItem('dep', dep);
						}
					}
				}
			}
		});
        $("#addressInput").keydown(function () {
			// Place is tiped into field and not chosen from the api responses
            isPlaceChanged = false;
        });		
		if(!app) {
			if(($.localStorage.getItem('registeredUser') != 1) && ($.localStorage.getItem('registeredUser') != 'OK'))
			{
				$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
			}
			else {
				$.post("https://www.mytaxiserver.com/taxioffsrv/blacklist.php", { userid: operator, tel: tel}, function(data) {
					if (data.banned == 1)
					{
						$.mobile.pageContainer.pagecontainer("change", "#subscription", { transition: "slide"} );
						var displayThis = '<p style="color:red;"><b>Votre compte &agrave; &eacute;t&eacute; banni pour cause d&rsquo;utilisation abusive, d&eacute;sol&eacute;.<br>Vous pouvez nous contacter pour toute r&eacute;clamation: </b></p><center><a href="mailto:info@taximedia.fr" class="ui-btn ui-btn-icon-left ui-icon-mail ui-btn-inline">Courriel</a><a href="tel:0491034263" class="ui-btn ui-btn-icon-left ui-icon-phone ui-btn-inline">T&eacute;l&eacute;phone</a></center>';
						$("#subReturns").empty().append(displayThis);
					}
					/*
					if(data.phone_ok != 'OK') {
						$.localStorage.setItem('registeredUser', 'KO');
						$.localStorage.setItem('firstConnexionVar', 'YES');
						$.mobile.pageContainer.pagecontainer("change", "#connect", { transition: "slide"} );
						var displayThis = '<p style="color:red;"><b>Le numéro de téléphone associé à votre compte doit être validé.<br>Vous pouvez vous connecter en utilisant vos identifiants ou vérifier votre numéro ci-dessus.</b></p>';
						$("#fogotReturns").empty().append(displayThis);
					}
					*/
				}, "json");
			}
			locateMe();
			$('.noAppHide').each(function () {
				$(this).hide();
			});
			$('#date').prop('type', 'text');
			$('#when').prop('type', 'text');
			$('#date').datebox({
				mode: "calbox",
				afterToday: true,
				useFocus: true
			});
			$('#when').datebox({
				mode: "timebox",
				overrideTimeOutput: "%k:%M",
				useFocus: true
			});
		}
		once = true;
 		// OpenData Areas Only... (#openDep-box)
		//$("#openDep-box").css("display", "none");
		var ok = setInterval( function () {
            var name_filled = document.getElementById("Accurate").value;
            var cell_filled = document.getElementById("cellular").value;
			var when = document.getElementById("when").value;
			var date = document.getElementById("date").value;
			var howMany = document.getElementById("howMany").value;
            
            if ((cell_filled != '') && (name_filled != ''))
            {
				if ((when != '') && (date != '')) {
					// Cmd here
					$("#next-box").hide("fast");
					$("#search-box").hide("fast");
					$("#book-box").show("medium");
				}
				else { // No Cmd
					$("#next-box").hide("fast");
					$("#book-box").hide("fast");
					$("#search-box").show("medium");
				}
            }
            else
            {
                $("#search-box").hide("fast");
				$("#book-box").hide("fast");
                $("#next-box").show("medium");
            }
			if(howMany>8) {
				if(once) {
					if(app) navigator.notification.alert('Pour plus de huit personnes veuillez passer une réservation SVP', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Pour plus de huit personnes veuillez passer une réservation SVP', alertDismissed, 'Mon Appli Taxi', 'OK');
					$('#book').slideToggle('slow');
					$('#date').focus();
				}
				once = false;
			}
        }, 1000);
		nom = $.localStorage.getItem('nom');
		tel = $.localStorage.getItem('tel');
		$('#Accurate').val(nom);
		$('#cellular').val(tel);
		$('.expends').click(function () {
			$(this).next('div').slideToggle('slow');
			//$.mobile.silentScroll($(this).next('div').offset().top);
		});
		/*
		$('#Pmr').change(function(){
			// special_need_vehicle needs the opendata...
			if ($(this).val()=='special_need_vehicle') {
				$('#tm-box').hide();
				if(app) navigator.notification.alert('Afin d\'obtenir un transport pour personne à mobilité réduite (TPMR), vous devez "choisir un taxi" (la "Proposition automatique" est donc désactivée).', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Afin d\'obtenir un transport pour personne à mobilité réduite (TPMR), vous devez "choisir un taxi" (la "Proposition automatique" est donc désactivée).');
			}
			else	$('#tm-box').show();
		});
		$('#Pet').change(function(){
			// pet_accepted needs the opendata...
			if ($(this).val()=='pet_accepted') {
				$('#tm-box').hide();
				if(app) navigator.notification.alert('Si vous désirez embarquer un animal, vous devez "choisir un taxi" (la "Proposition automatique" est donc désactivée).', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Si vous désirez embarquer un animal, vous devez "choisir un taxi" (la "Proposition automatique" est donc désactivée).');
			}
			else	$('#tm-box').show();
		});
		*/
		$('#regLinks').append('<fieldset data-role="controlgroup"><legend>Derni&egrave;res informations saisies:</legend>');
		for(n=1;n<4;n++) {
			if(($.localStorage.getItem('regName'+n) != null) && ($.localStorage.getItem('regCell'+n) != null)) {
				rName = $.localStorage.getItem('regName'+n);
				rCell = $.localStorage.getItem('regCell'+n);
				$('#regLinks').append('<button id="reg'+n+'" onClick="Fillin(\''+rName+'\',\''+rCell+'\')" class="ui-shadow ui-btn ui-btn-b ui-corner-all ui-icon-star">'+rName+' - '+rCell+'</button>');
			}
		}
		$('#regLinks').append('</fieldset>');
	});
	$( '#prices' ).live( 'pagecreate',function(event){
		var input = document.getElementById('addressInputPrices');
		var input2 = document.getElementById('DestAddressPrices');
		var options = {
		  componentRestrictions: {country: 'fr'}
		};
		var autocomplete = new google.maps.places.Autocomplete(input, options);
		// fired when an autocomplete option is selected or the input is submitted
		google.maps.event.addListener(autocomplete, 'place_changed', function() {
			//navigator.notification.alert('Fired');
			var place = autocomplete.getPlace();
			var address = '';
			if (place.address_components) {
				address = [
					(place.address_components[0] && place.address_components[0].short_name || ''),
					(place.address_components[1] && place.address_components[1].short_name || ''),
					(place.address_components[2] && place.address_components[2].short_name || '')
				].join(' ');
			}
		});
		var autocomplete2 = new google.maps.places.Autocomplete(input2, options);
		// fired when an autocomplete option is selected or the input is submitted
		google.maps.event.addListener(autocomplete2, 'place_changed', function() {
			//navigator.notification.alert('Fired');
			var place = autocomplete.getPlace();
			var address = '';
			if (place.address_components) {
				address = [
					(place.address_components[0] && place.address_components[0].short_name || ''),
					(place.address_components[1] && place.address_components[1].short_name || ''),
					(place.address_components[2] && place.address_components[2].short_name || '')
				].join(' ');
			}
		});
	});
	function locateMe() {
		if (navigator.geolocation)
		{
			if (navigator.userAgent.toLowerCase().match(/android/)) {
				navigator.geolocation.getCurrentPosition(codeLatLng, showError,{enableHighAccuracy:false, maximumAge:0, timeout: 9000});
			}
			else {
				navigator.geolocation.getCurrentPosition(codeLatLng, showError,{enableHighAccuracy:true, maximumAge:0, timeout: 9000});
			}
		}
		else {
			if(app) navigator.notification.alert("Localisation impossible, veuillez v&eacute;rifier l'&eacute;tat de votre connection ainsi que la disponibilit&eacute; des services de localisation dans les réglages de votre appareil.", alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert("Localisation impossible, veuillez v&eacute;rifier l'&eacute;tat de votre connection ainsi que la disponibilit&eacute; des services de localisation dans les réglages de votre appareil.");
		}
	}
	function codeLatLng(position) {
		// Using http://adresse.data.gouv.fr
		lat = position.coords.latitude;
		lng = position.coords.longitude;
		//http://api-adresse.data.gouv.fr/reverse/?lon=2.37&lat=48.357&type=street
		$.get('http://api-adresse.data.gouv.fr/reverse/', {lat: lat, lon: lng, type: ''}, function(data) {
			//alert(data.features[0].properties.label+' - '+data.features[0].properties.postcode);
			if(data.features[0].properties.label!='baninfo') {
				// Reverse geocoding is OK...
				$('#addressInput').val(data.features[0].properties.label);
				$('#addressInput2').val(data.features[0].properties.label);
				$('#addressInputPrices').val(data.features[0].properties.label);
				insee = data.features[0].properties.citycode;
				zip = data.features[0].properties.postcode;
				dep = zip.substring(0, 2);
				$.sessionStorage.setItem('dep', dep);
			}
			else {
				if(app) navigator.notification.alert('Adresse inconnue !! Veuillez la saisir manuellement SVP.', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Adresse inconnue !! Veuillez la saisir manuellement SVP.');
			}
		}, "json").done(function() {
			/*
			// OpenData Areas Only... (#openDep-box)
			$.post("https://www.mytaxiserver.com/appclient/open_areas.php", { insee: insee, zip: zip, dep: dep}, function(data) {
				if (data.go == "ok")
				{
					$("#openDep-box").show();
					$("#search").text("Proposition automatique");
				}
			}, "json");
			*/
		});
	}
	function codeLatLngGmaps(position) {
		var geocoder = new google.maps.Geocoder();
		lat = position.coords.latitude;
		lng = position.coords.longitude;
		var latlng = new google.maps.LatLng(lat, lng);
		geocoder.geocode({'latLng': latlng}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK)
			{
				if (results[0]) {
					$('#addressInput').val(results[0].formatted_address);
					$('#addressInput2').val(results[0].formatted_address);
					for(var i=0; i < results[0].address_components.length; i++)
					{
						var component = results[0].address_components[i];
						if(component.types[0] == "postal_code")
						{
							//navigator.notification.alert(component.long_name);
							zip = component.long_name;
							dep = zip.substring(0, 2);
							$.sessionStorage.setItem('dep', dep);
						}
					}
				}
				else {
					if(app) navigator.notification.alert('Adresse inconnue !!', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Adresse inconnue !!');
				}
			}
			else {
				if(app) navigator.notification.alert('Geocoder failed due to: ' + status, alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert(geoAlert);
			}
		});
	}
	function showError(error)
	{
		var x=document.getElementById("resultsGeo");
		var geoAlert="";
		switch(error.code) 
		{
			case error.PERMISSION_DENIED:
			  x.innerHTML="<strong>Vous avez refus&eacute; l&rsquo;acc&egrave;s &agrave; la G&eacute;olocalisation.</strong>"
			  geoAlert="Vous avez refusé l'accès à la Géolocalisation, vous pouvez modifier cela dans les réglages.";
			  break;
			case error.POSITION_UNAVAILABLE:
			  x.innerHTML="<strong>G&eacute;olocalisation indisponible, veuillez regarder dans l&rsquo;aide ou activer le service dans les reglages de votre appareil.</strong>"
			  geoAlert="Géolocalisation indisponible, veuillez regarder dans l'aide ou activer le service dans les reglages de votre appareil.";
			  break;
			case error.TIMEOUT:
			  x.innerHTML="<strong>La demande de G&eacute;olocalisation a expir&eacute;, veuillez v&eacute;rifier l'&eacute;tat de votre connection ainsi que la disponibilit&eacute; des services de localisation (user location request timed out).</strong>"
			  geoAlert="La demande de Géolocalisation a expiré, veuillez vérifier l'état de votre connection ainsi que la disponibilité des services de localisation (user location request timed out).";
			  break;
			case error.UNKNOWN_ERROR:
			  x.innerHTML="<strong>Erreur inconnue de G&eacute;olocalisation (unknown error occurred).</strong>"
			  geoAlert="Erreur inconnue de Géolocalisation (unknown error occurred).";
			  break;
			default:
			  x.innerHTML="<strong>Erreur de G&eacute;olocalisation, red&eacute;marrage du smartphone n&eacute;c&eacute;ssaire.</strong>"
			  geoAlert="Erreur de Géolocalisation, libre à vous d'activer le service de géolocalisation pour cette app dans les réglages.";
		}
		if (error.code == error.TIMEOUT) {
			// Fall back to low accuracy and any cached position available...
			navigator.geolocation.getCurrentPosition(codeLatLng, function(){
				//$( "#errorPop" ).popup( "open", { positionTo: "window" } );
				if(app) navigator.notification.alert(geoAlert, alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert(geoAlert);
			},{enableHighAccuracy:false, maximumAge:Infinity, timeout: 6000});
		}
		else {
			//$( "#errorPop" ).popup( "open", { positionTo: "window" } );
			if(app) navigator.notification.alert(geoAlert, alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert(geoAlert);
		}
	}
	function Fillin(Name, Cell)
	{
		$('#Accurate').val(Name);
		$('#cellular').val(Cell);
		$("#next-box").hide("fast");
		$("#rememberMe").popup("close");
		$("#search-box").show("medium");
		dontReg = true;
	}
	function checkZip(pageToGo) {
		$('#search').prop('disabled', true).addClass('ui-disabled'); // Prevents from multitap
		$('#searchOpen').prop('disabled', true).addClass('ui-disabled'); // Prevents from multitap
		dep = $.sessionStorage.getItem('dep');
		var isAddr = document.getElementById("addressInput").value;
		if(isAddr!='') {
			if (isPlaceChanged || (dep != '') || (zip != '')) {
				$.mobile.pageContainer.pagecontainer("change", pageToGo, { transition: "slide", reverse: true} );
			}
			else {
				//navigator.notification.alert('No Zip Code Here !!');
				$("#setZipBtn").attr("title", pageToGo); // Remembering pageToGo for setZip function, changing onClick attr is bad practice.
				$( "#setZip" ).popup( "open", { positionTo: "window" } );
			}
		}
		else {
			if(app) navigator.notification.alert('Veuillez renseigner une adresse ou attendre la fin de la géolocalisation SVP...', alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert('Veuillez renseigner une adresse ou attendre la fin de la géolocalisation SVP...');
		}
		$('#search').prop('disabled', false).removeClass('ui-disabled'); // Button is back
		$('#searchOpen').prop('disabled', false).removeClass('ui-disabled'); // Button is back
	}
	function setZip() {
		zip = $('#zipDep').val();
		dep = zip.substring(0, 2);
		zipChecked = true;
		$.sessionStorage.setItem('dep', dep);
		var when = document.getElementById("when").value;
		var date = document.getElementById("date").value;
		if ((when != '') && (date != '')) {
			booking();
		}
		else {
			$.mobile.pageContainer.pagecontainer("change", "#map_page", { transition: "slide", reverse: true} );
		}
	}
	$('#map_page_open').live('pagecreate', function() {
		/*
        endcourse = setTimeout( function () {
            $("#cancel").trigger('click');
        }, 180000);
		*/
		$('#map_open').gmap({'center': mobileMap.center, 'zoom': mobileMap.zoom, 'disableDefaultUI':false, 'mapTypeId': google.maps.MapTypeId.ROADMAP, 'callback': function() {
			var self = this;
			var geocoder = new google.maps.Geocoder();
			var  address = $('#addressInput').val();
			//var address = document.getElementById("addressInput").value;
			geocoder.geocode({address: address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					//$('#dblinks').append($('<p>' + results[0].geometry.location + '__RDV</p>'));
					var myPlace = results[0].geometry.location;
					$.mobile.loading( "show" );
					for(var i=0; i < results[0].address_components.length; i++)
					{
						var component = results[0].address_components[i];
						if(component.types[0] == "postal_code")
						{
							//navigator.notification.alert(component.long_name);
							zip = component.long_name;
							dep = zip.substring(0, 2);
							$.sessionStorage.setItem('dep', dep);
						}
					}
					//self.refresh();
					wait4Me = setTimeout( function () {
						searchLocationsNearOpen(myPlace, self);
						//$.mobile.loading( "hide" );
					}, 2000);
					
					var userIcon = 'visuels/client_loc_icon.png';
					self.get('map').panTo(myPlace);
					//self.get('map').setZoom(12);
					//self.get('map').setCenter(myPlace);
					self.addMarker({'position': myPlace, 'bounds': true, 'icon': userIcon }).click(function() {
						self.openInfoWindow({ 'content': '<p style="color:#333;"><b>Vous &ecirc;tes ici:<br>'+address+'</b></p>' }, this);
					});
					//var gcenter = myPlace.lat().toFixed(4) +", "+ myPlace.lng().toFixed(4);
					//var circleCenter = new google.maps.LatLng(gcenter);
					self.addShape('Circle', {
						'strokeWeight': 0, 
						'fillColor': "#008595", 
						'fillOpacity': 0.25, 
						'center': myPlace, 
						'radius': 2000, 
						'clickable': false 
					});
					
					//searchLocationsNearOpen(myPlace, self);
				} else {
					if(app) navigator.notification.alert(address + ' ADRESSE NON TROUVEE !');
					else alert(address + ' ADRESSE NON TROUVEE !');
					//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide", reverse: true} );
					refreshApp();
				}
			});
		}}); 
	});
	
	$('#map_page_open').live('pageshow', function() {
		//demo.add('basic_map', function() { $('#map').gmap('refresh'); }).load('basic_map');
		//$('#map').gmap("option", "center", mobileMap.center);
		$('#map_open').gmap('refresh');
	});
	////////////////////////////////////////////////////////////
	
	$( '#map_page' ).live( 'pagebeforeshow',function(event){
		//$('#map').gmap('clear', 'markers');
		//$('#dblinks').empty();	 
	});
	
	$('#map_page').live('pagecreate', function() {
        endcourse = setTimeout( function () {
			if(!stopCheckAnswer) {
				$("#cancel").trigger('click');
				badgeNumber = 1;
				cordova.plugins.notification.local.schedule({
					id: 1,
					title: "Mon Appli Taxi",
					text: "Aucun taxi n'a pris la course, veuillez réessayer SVP.",
					led: "E7B242",
					badge: badgeNumber
				});
				playAudio('sounds/ring.mp3');
			}
        }, 180000);
		// NYC-WIFI Animations
		var wc = 1;
		var elapsed = 180;
		var opacAnim= false;
		var minusAnim= false;
		setInterval( function () {
			elapsed--;
			if (wc>3) {
				minusAnim = !minusAnim;
			}
			if (minusAnim) wc--;
			else wc++;
			if (wc==0) {
				wc=1;
				minusAnim = !minusAnim;
				opacAnim = !opacAnim;
			}
			var imgPath = "visuels/wifi-"+wc+".png";
			if (opacAnim) $('#animSearch #wifiSteps').animate({ opacity: 0 }, 500, function () { $(this).attr("src", imgPath)}).animate({ opacity: 1 }, 500);
			else $('#animSearch #wifiSteps').attr("src", imgPath);
			$('.elapsed').text(elapsed);
        }, 1000);
		$.mobile.loading( "show" );
		var  address = $('#addressInput').val();
		$.get('http://api-adresse.data.gouv.fr/search/', {q: address, type: ''}, function(data) {
		}, "json").done(function(data) { 
			if(data.features[0].properties.label!='baninfo') {
				// Geocoding is OK...
				insee = data.features[0].properties.citycode;
				zip = data.features[0].properties.postcode;
				dep = zip.substring(0, 2);
				$.sessionStorage.setItem('dep', dep);
				searchLocationsNearNoMap(data.features[0].geometry.coordinates[1], data.features[0].geometry.coordinates[0]);
			}
			else {
				if(app) navigator.notification.alert('Adresse inconnue !! Veuillez la saisir manuellement SVP.', alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert('Adresse inconnue !! Veuillez la saisir manuellement SVP.');
			}
		}).always(function(data) { 
			$.mobile.loading( "hide" );
		});
		/*
		$('#map').gmap({'center': mobileMap.center, 'zoom': mobileMap.zoom, 'disableDefaultUI':false, 'mapTypeId': google.maps.MapTypeId.ROADMAP, 'callback': function() {
			var self = this;
			var geocoder = new google.maps.Geocoder();
			var  address = $('#addressInput').val();
			//var address = document.getElementById("addressInput").value;
			geocoder.geocode({address: address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					//$('#dblinks').append($('<p>' + results[0].geometry.location + '__RDV</p>'));
					var myPlace = results[0].geometry.location;
					$.mobile.loading( "show" );
					for(var i=0; i < results[0].address_components.length; i++)
					{
						var component = results[0].address_components[i];
						if(component.types[0] == "postal_code")
						{
							//navigator.notification.alert(component.long_name);
							zip = component.long_name;
							dep = zip.substring(0, 2);
							$.sessionStorage.setItem('dep', dep);
						}
					}
					//self.refresh();
					wait4Me = setTimeout( function () {
						searchLocationsNear(myPlace, self);
						//$.mobile.loading( "hide" );
					}, 2000);
					
					var userIcon = 'visuels/business_loc_icon.png';
					self.get('map').panTo(myPlace);
					//self.get('map').setZoom(12);
					//self.get('map').setCenter(myPlace);
					self.addMarker({'position': myPlace, 'bounds': true, 'icon': userIcon }).click(function() {
						self.openInfoWindow({ 'content': '<p style="color:#333;">'+address+' / Lieu de prise en charge</p>' }, this);
					});
					//var gcenter = myPlace.lat().toFixed(4) +", "+ myPlace.lng().toFixed(4);
					//var circleCenter = new google.maps.LatLng(gcenter);
					self.addShape('Circle', {
						'strokeWeight': 0, 
						'fillColor': "#008595", 
						'fillOpacity': 0.25, 
						'center': myPlace, 
						'radius': 2000, 
						'clickable': false 
					});
					
					//searchLocationsNear(myPlace, self);
				} else {
					if(app) navigator.notification.alert(address + ' NON TROUVEE ', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert(address + ' NON TROUVEE ');
					$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide", reverse: true} );
				}
			});
		}});
		*/
        // Auto Click and deliver courses to cabs
        $('#deliver').click(function () {
                                 
            check_answer();
                        
			var index = 0;
			$('#dblinks #' + index).trigger('click');// Deliver to the first before timer !!
			index++; // Now index = 1
			time = setInterval( function () {
				var stoper = document.getElementById('stop').value;
				if (stoper != 1) {$('#dblinks #' + index).trigger('click');}
				if ((index > 5) || (stoper == 1) || stopCheckAnswer) {
					// THIS ONE IS THE 0000 CAB AND LAST ONE SO...
					clearInterval(time); // Clears the current Interval
                    //clearTimeout(endcourse);
					//navigator.notification.alert('Aucun taxi ne prend la course !!');
					//return false;
				}
				index++;
			}, 10000);    
        });
	});
	/*
	$('#map_page').live('pageshow', function() {
		//demo.add('basic_map', function() { $('#map').gmap('refresh'); }).load('basic_map');
		//$('#map').gmap("option", "center", mobileMap.center);
		$('#map').gmap('refresh');
	});
	*/
	////////////////////////////////////////////////////////////
		
	$('#fleet_page').live('pagecreate', function() {
		$('#fleet_map').gmap({'center': mobileMap.center, 'zoom': mobileMap.zoom, 'disableDefaultUI':true, 'mapTypeId': google.maps.MapTypeId.ROADMAP, 'callback': function() {
			var self = this;
			dep = $.sessionStorage.getItem('dep');
			$.post('http://www.mytaxiserver.com/appserver/station_fleet_xml.php?group=1&dep='+dep, function(xml){
				$(xml).find('marker').each(function(){
					var name = $(this).attr('name');
					var address = $(this).attr('address');
					var lat = $(this).attr('lat');
					var lng = $(this).attr('lng');
					var timestamp = $(this).attr('timestamp');
					i = $(this).attr('count');
					var latlng = new google.maps.LatLng(lat, lng);			
					var display_name = 'Taxi ' + name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					//self.get('map').panTo(latlng);
					//self.get('map').setZoom(12);
					//self.get('map').setCenter(myPlace);
					self.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': display_name, 'icon': cabIcon }).click(function() {
						infoCont = '<p style="color:#333;"><b>taxi n&deg; ' + name + ' - ' + address+ '</b></p>';
						self.openInfoWindow({ 'content':  infoCont}, this);
					});
				});
				$('.cabNum').empty().append('Il y a actuellement '+i+' Taxis disponibles.');
			});
		}});
	});
	
	$('#fleet_page').live('pageshow', function() {
		$('#fleet_map').gmap('refresh');
	});
	////////////////////////////////////////////////////////////
	
	function followOpenCab(hailToFollow, frdv)
	{
		$.sessionStorage.setItem('hail_id', hailToFollow);
		$.sessionStorage.setItem('frdv', frdv);
		$.mobile.pageContainer.pagecontainer("change", "#follow_open", { transition: "slide"} );
	}
	$('#follow_open').live('pagecreate', function() {
		hail_id = $.sessionStorage.getItem('hail_id');
		var frdv = $.sessionStorage.getItem('frdv');
		//alert(hail_id + " - " + frdv);
		$('#follow_map_open').gmap({'center': mobileMap.center, 'zoom': mobileMap.zoom, 'disableDefaultUI':true, 'mapTypeId': google.maps.MapTypeId.ROADMAP, 'callback': function() {
			var self = this;
			navigator.geolocation.getCurrentPosition(function(position, status) {
				var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				lat = position.coords.latitude;
				lng = position.coords.longitude;
				self.get('map').panTo(latlng);
				var userIcon = 'visuels/client_loc_icon.png';
				self.addMarker({ id: 'you', 'position': latlng, 'bounds': true, 'icon': userIcon }).click(function() {
					self.openInfoWindow({ 'content':  '<p style="color:#09F;"><b>Vous &Ecirc;tes ici</b></p>' }, this);
				});
				/*
				self.addShape('Circle', {
					'strokeWeight': 0, 
					'fillColor': "#008595", 
					'fillOpacity': 0.25, 
					'center': latlng, 
					'radius': 500, 
					'clickable': true 
				});
				*/
			}, showError,{enableHighAccuracy:true, maximumAge:0});
			var geocoder = new google.maps.Geocoder();
			var address = frdv;
			geocoder.geocode({address: address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					var rdvPlace = results[0].geometry.location;
					//self.refresh();
					var rdvIcon = 'visuels/rdv_marker.png';
					self.get('map').panTo(rdvPlace);
					//self.get('map').setZoom(12);
					//self.get('map').setCenter(rdvPlace);
					self.addMarker({'position': rdvPlace, 'bounds': true, 'icon': rdvIcon }).click(function() {
						self.openInfoWindow({ 'content': '<p style="color:#6C0;"><b>Lieu de prise en charge</b></p>' }, this);
					});
					//var gcenter = rdvPlace.lat().toFixed(4) +", "+ rdvPlace.lng().toFixed(4);
					//var circleCenter = new google.maps.LatLng(gcenter);
					self.addShape('Circle', {
						'strokeWeight': 0, 
						'fillColor': "#008595", 
						'fillOpacity': 0.25, 
						'center': rdvPlace, 
						'radius': 500, 
						'clickable': true 
					});
				} else {
					if(app) navigator.notification.alert('ADRESSE RDV : '+address+' NON TROUVEE ');
					else alert('ADRESSE RDV : '+address+' NON TROUVEE ');
				}
			});
			//$.post('https://www.mytaxiserver.com/appserver/open_follow.php', { hail_id: hail_id }, function(data){
			$.post('http://www.mytaxiserver.com/appserver/open_follow.php', { hail_id: hail_id }, function(data){
				if(data.ok) {
					var latlng = new google.maps.LatLng(data.lat, data.lng);
					var display_name = 'Taxi ' + data.name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					self.addMarker({ id: 'cab', 'position': latlng, 'bounds': true, 'icon': cabIcon }).click(function() {
						infoCont = '<p style="color:#333;"><b>Votre taxi joignable au: ' + data.address + '<br><span style="font-size: x-small;">(aclualis&eacute; &agrave; ' + data.timestamp+ ')</span></b></p>';
						self.openInfoWindow({ 'content':  infoCont}, this);
					});
				}
				else {
					if(app) navigator.notification.alert('Vous ne pouvez suivre un taxi que 30 minutes avant le RDV !!', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Vous ne pouvez suivre un taxi que 30 minutes avant le RDV !!');
					//document.location.href='index.html';
					$.mobile.pageContainer.pagecontainer("change", "#history", { transition: "slide"} );
				}
				//alert(data.lat+', '+data.lng+' - '+data.name+' - '+data.address+' '+data.timestamp);
			}, "json").fail(function (jqXHR, textStatus, errorThrown) {
				navigator.notification.alert('Erreur inconnue, le serveur ou la connexion internet sont indisponibles. ' + textStatus+', '+ errorThrown, alertDismissed, 'Mon Appli Taxi Erreur', 'OK');
			});
			var track = setInterval( function () {
				//$.post('https://www.mytaxiserver.com/appserver/open_follow.php', {  hail_id: hail_id }, function(data){
				$.post('http://www.mytaxiserver.com/appserver/open_follow.php', {  hail_id: hail_id }, function(data){
					//alert(data.lat+', '+data.lng+' - '+data.name+' - '+data.address+''+data.timestamp);
					markerCab = self.get('markers')['cab'];
					markerCab.setVisible(false);
					var latlng = new google.maps.LatLng(data.lat, data.lng);
					var display_name = 'Taxi ' + data.name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					self.addMarker({ id: 'cab', 'position': latlng, 'bounds': true, 'icon': cabIcon }).click(function() {
						infoCont = '<p style="color:#333;"><b>Votre taxi joignable au: <a data-ajax="false" href="tel:' + data.address + '" class="ui-btn ui-btn-c ui-corner-all ui-shadow ui-icon-phone ui-btn-icon-left">' + data.address + '</a><span style="font-size: x-small;">(aclualis&eacute; &agrave; ' + data.timestamp+ ')</span></b></p>';
						//infoCont = '<p style="color:#333;"><b>Votre taxi joignable au: <a data-ajax="false" href="tel:' + data.address + '" class="ui-btn ui-btn-c ui-corner-all ui-shadow ui-icon-phone ui-btn-icon-left">' + data.address + '</a></b></p>';
						self.openInfoWindow({ 'content':  infoCont}, this);
					});
					var markerYou = self.get('markers')['you'];
					markerYou.setVisible(false);
					navigator.geolocation.getCurrentPosition(function(position, status) {
						var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
						lat = position.coords.latitude;
						lng = position.coords.longitude;
						self.get('map').panTo(latlng);
						var userIcon = 'visuels/client_loc_icon.png';
						self.addMarker({ id: 'you', 'position': latlng, 'bounds': true, 'icon': userIcon }).click(function() {
							self.openInfoWindow({ 'content':  '<p style="color:#09F;"><b>Vous &Ecirc;tes ici</b></p>' }, this);
						});
					}, showError,{enableHighAccuracy:true, maximumAge:0});
				}, "json");
			}, 10000);
		}});
	});
	
	$('#follow_open').live('pageshow', function() {
		$('#follow_map_open').gmap('refresh');
	});
	////////////////////////////////////////////////////////////
	
	function followCab(ftaxi, fidcourse, fdep, ftel, frdv, ftable)
	{
		$.sessionStorage.setItem('ftaxi', ftaxi);
		$.sessionStorage.setItem('fidcourse', fidcourse);
		$.sessionStorage.setItem('fdep', fdep);
		$.sessionStorage.setItem('ftel', ftel);
		$.sessionStorage.setItem('frdv', frdv);
		$.sessionStorage.setItem('ftable', ftable);
		$.mobile.pageContainer.pagecontainer("change", "#follow", { transition: "slide"} );
	}
	$('#follow').live('pagecreate', function() {
		var ftaxi = $.sessionStorage.getItem('ftaxi');
		var fidcourse = $.sessionStorage.getItem('fidcourse');
		var fdep = $.sessionStorage.getItem('fdep');
		var ftel = $.sessionStorage.getItem('ftel');
		var frdv = $.sessionStorage.getItem('frdv');
		var ftable = $.sessionStorage.getItem('ftable');
		$('#follow_map').gmap({'center': mobileMap.center, 'zoom': mobileMap.zoom, 'disableDefaultUI':true, 'mapTypeId': google.maps.MapTypeId.ROADMAP, 'callback': function() {
			var self = this;
			navigator.geolocation.getCurrentPosition(function(position, status) {
				var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
				self.get('map').panTo(latlng);
				var userIcon = 'visuels/business_loc_icon.png';
				self.addMarker({ id: 'you', 'position': latlng, 'bounds': true, 'icon': userIcon }).click(function() {
					self.openInfoWindow({ 'content':  '<p style="color:#09F;"><b>Vous &Ecirc;tes ici</b></p>' }, this);
				});
			}, showError,{enableHighAccuracy:true, maximumAge:0});
			var geocoder = new google.maps.Geocoder();
			var address = frdv;
			geocoder.geocode({address: address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					var rdvPlace = results[0].geometry.location;
					//self.refresh();
					var rdvIcon = 'visuels/rdv_marker.png';
					self.get('map').panTo(rdvPlace);
					//self.get('map').setZoom(12);
					//self.get('map').setCenter(rdvPlace);
					self.addMarker({'position': rdvPlace, 'bounds': true, 'icon': rdvIcon }).click(function() {
						self.openInfoWindow({ 'content': '<p style="color:#6C0;"><b>Lieu de prise en charge</b></p>' }, this);
					});
					//var gcenter = rdvPlace.lat().toFixed(4) +", "+ rdvPlace.lng().toFixed(4);
					//var circleCenter = new google.maps.LatLng(gcenter);
					self.addShape('Circle', {
						'strokeWeight': 0, 
						'fillColor': "#008595", 
						'fillOpacity': 0.25, 
						'center': rdvPlace, 
						'radius': 500, 
						'clickable': true 
					});
				} else {
					if(app) navigator.notification.alert('ADRESSE RDV : '+address+' NON TROUVEE ', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('ADRESSE RDV : '+address+' NON TROUVEE ');
				}
			});
			$.post('https://www.mytaxiserver.com/appserver/follow.php', { taxi: ftaxi, idcourse: fidcourse, dep: fdep, tel: ftel, table: ftable }, function(data){
				if(data.ok) {
					var latlng = new google.maps.LatLng(data.lat, data.lng);
					var display_name = 'Taxi ' + data.name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					self.addMarker({ id: 'cab', 'position': latlng, 'bounds': true, 'title': display_name, 'icon': cabIcon }).click(function() {
						infoCont = '<p style="color:#333;"><b>taxi n&deg; ' + data.name + ' - ' + data.address+ ' &agrave; ' + data.timestamp+ '</b></p>';
						self.openInfoWindow({ 'content':  infoCont}, this);
					});
				}
				else {
					if(app) navigator.notification.alert('Vous ne pouvez suivre un taxi que 30 minutes avant le RDV !!', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Vous ne pouvez suivre un taxi que 30 minutes avant le RDV !!');
					//document.location.href='index.html';
					$.mobile.pageContainer.pagecontainer("change", "#history", { transition: "slide"} );
				}
			}, "json");
			var track = setInterval( function () {
				$.post('https://www.mytaxiserver.com/appserver/follow.php', { taxi: ftaxi, idcourse: fidcourse, dep: fdep, tel: ftel, table: ftable }, function(data){
					markerCab = self.get('markers')['cab'];
					markerCab.setVisible(false);
					var latlng = new google.maps.LatLng(data.lat, data.lng);
					var display_name = 'Taxi ' + data.name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					self.addMarker({ id: 'cab', 'position': latlng, 'bounds': true, 'title': display_name, 'icon': cabIcon }).click(function() {
						infoCont = '<p style="color:#333;"><b>taxi n&deg; ' + data.name + ' - ' + data.address+ ' &agrave; ' + data.timestamp+ '</b></p>';
						self.openInfoWindow({ 'content':  infoCont}, this);
					});
					var markerYou = self.get('markers')['you'];
					markerYou.setVisible(false);
					navigator.geolocation.getCurrentPosition(function(position, status) {
						var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
						self.get('map').panTo(latlng);
						var userIcon = 'visuels/business_loc_icon.png';
						self.addMarker({ id: 'you', 'position': latlng, 'bounds': true, 'icon': userIcon }).click(function() {
							self.openInfoWindow({ 'content':  '<p style="color:#09F;"><b>Vous &Ecirc;tes ici</b></p>' }, this);
						});
					}, showError,{enableHighAccuracy:true, maximumAge:0});
				}, "json");
			}, 10000); 
		}});
	});
	
	$('#follow').live('pageshow', function() {
		$('#follow_map').gmap('refresh');
	});
	////////////////////////////////////////////////////////////
	
	function searchLocationsNearOpen(center, mapEvent) {
		//clearLocations();
		//navigator.notification.alert('In searchLocationsNearOpen');
		$('#map_open').gmap('refresh');
		var myDate = new Date();
		idcourse = myDate.getTime();
		//var radius = document.getElementById('radiusSelect').value;
		var rdvpoint = document.getElementById("addressInput").value;
		var room = document.getElementById("Accurate").value;
		operator = $.localStorage.getItem('operator');
		var hostname = document.getElementById("hostname").value;
		var howMany = document.getElementById("howMany").value;
		var typecar = document.getElementById("CarType").value;
		var cb = document.getElementById("Pay").value;
		var pmr = document.getElementById("Pmr").value;
		var pet = document.getElementById("Pet").value;
		var group = document.getElementById("group").value;
		var payment = "Non";
		if(cb == 1) {
			payment = "Oui";
		}
		var coms = document.getElementById("coms").value.replace(/'/g, "&rsquo;");
		var comments1 = '<ul><li>Nom du client : ' + room + '</li><li>Paiement CB : ' + payment + '</li><li>Nombre de passagers : ' + howMany + '</li><li>Type de vehicule : ' + typecar + '</li>';
		if (coms != '') {
			var comments2 = '<li>' + coms + '</li></ul>';
		}
		else {
			var comments2 = '</ul>';
		}
		var comments = comments1+comments2;
		var dest = document.getElementById("DestAddress").value;
		var cell = document.getElementById("cellular").value;
		var when = document.getElementById("when").value;
		var date = document.getElementById("date").value;
		//var medic = document.getElementById("medic").value;
		if (!dontReg) {
			for(n=1;n<4;n++) {
				if(($.localStorage.getItem('regName'+n) == null) && ($.localStorage.getItem('regCell'+n) == null)) {
					var regName = $.localStorage.setItem('regName'+n, $('#Accurate').val());
					var regCell = $.localStorage.setItem('regCell'+n, cell);
					var regLast = $.localStorage.setItem('regLast', n);
					var writen = true;
					break;
				}
			}
			if(!writen) {
				var regLast = $.localStorage.getItem('regLast');
				switch (regLast) {
					case '1':
						var entry = 2;
					  break;
					case '2':
						var entry = 3;
					  break;
					case '3':
						var entry = 1;
					  break;
					default:
				}
				var regName = $.localStorage.setItem('regName'+entry, $('#Accurate').val());
				var regCell = $.localStorage.setItem('regCell'+entry, cell);
			}
		}
		var rdvlat = center.lat();
		var rdvlng = center.lng();
		//url = '';
		num_req = idcourse;
		dep = $.sessionStorage.getItem('dep');
		//i = 0; // We need to make any numreq unique on that one !!
		var openAvail = false;
		var once = true; // we only trigger the first marker
		//$.post('https://www.mytaxiserver.com/appserver/open_app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, group: group, dep: dep, zip: zip, pass: 'true'}, function(xml){
		$.post('http://www.mytaxiserver.com/appserver/open_app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, pmr: pmr, pet: pet, group: group, dep: dep, zip: zip, pass: 'true'}, function(xml){
			//navigator.notification.alert('IN');
			$(xml).find('marker').each(function(){
				var cabid = $(this).attr('cabid');
				var name = $(this).attr('name');
				var appname = $(this).attr('appname');
				var address = $(this).attr('address');
				var licence = $(this).attr('taxi');
				var rating = $(this).attr('rating');
				var brand = $(this).attr('constructor');
				var model = $(this).attr('model');
				var color = $(this).attr('color');
				var licence_plate = $(this).attr('licence_plate');
				var seats = $(this).attr('seats');
				var lat2 = $(this).attr('lat');
				var lng2 = $(this).attr('lng');
				var timestamp = $(this).attr('timestamp');
				var distance = $(this).attr('distance');
				var i = $(this).attr('count');
				//num_req = num_req+1;
				var latlng = new google.maps.LatLng(lat2, lng2);
				var display_name = 'Taxi ' + name;
				var cabIcon = 'visuels/taxi_loc_icon.png';
				var otherCabIcon = 'visuels/not_taxi_loc_icon.png';
				var url = 'taxi=' + name + '&tel=' + address + '&cabid=' + cabid + '&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&appname=' + appname + '&dep='+dep+'&group=1&ack=0&db=1';
				//url = 'rdvpoint=' + rdvpoint + '&operator=' + operator + '&lat=' + rdvlat + '&lng=' + rdvlng + '&cell=' + cell + '&appname=' + appname + '&cabid=' + cabid + '&dep='+dep+'&group=1&ack=0&db=1';
				url = url.replace(/'/g, "&rsquo;");
				url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
				if(appname=="montaxi") {
					var mymarker = mapEvent.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': name, 'icon': cabIcon }).click(function() {
						infoCont = '<div id="infoCont"><ul style="color:#333;"><b><li>Taxi Num&eacute;ro : '+licence+'</li><li>Distance : '+parseFloat(distance).toFixed(1) + ' Km de vous</li><li>Marque : '+brand+'</li><li>Mod&egrave;le : '+model+'</li><li>Couleur : '+color+'</li><li>Places : '+seats+'</li><li>Note : '+rating+' / 5</li><li>Imatriculation : '+licence_plate+'</li></b></ul></div>';
						callBtn='<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>';
						//mapEvent.openInfoWindow({ 'content':  infoCont}, this);
						mapEvent.openInfoWindow({ 'content':  infoCont+callBtn}, this);
					});
					if(once) {
						new google.maps.event.trigger(mymarker[0],'click');
						once = false; // we only trigger the first
					}
				}
				else {
					mapEvent.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': name, 'icon': otherCabIcon }).click(function() {
						infoCont = '<div id="infoCont"><ul style="color:#333;"><b><li>Taxi Num&eacute;ro : '+licence+'</li><li>Distance : '+parseFloat(distance).toFixed(1) + ' Km de vous</li><li>Marque : '+brand+'</li><li>Mod&egrave;le : '+model+'</li><li>Couleur : '+color+'</li><li>Places : '+seats+'</li><li>Note : '+rating+' / 5</li><li>Imatriculation : '+licence_plate+'</li></b></ul></div>';
						callBtn='<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>';
						//mapEvent.openInfoWindow({ 'content':  infoCont}, this);
						mapEvent.openInfoWindow({ 'content':  infoCont+callBtn}, this);
					});
				}
				openAvail = true; // There is at least one available cab here
				countMarkerCab = i;
				//mapEvent.addBounds(latlng);
				//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
				//$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJobOpen(\''+ url +'\')" />'));
				//$('#dblinks').append($('<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>'));
				//$('#infoCont').append($('<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>'));
			});
			if(!openAvail) {
				// special_need_vehicle needs the opendata...
				if ($('#Pmr').val()=='special_need_vehicle') {
					if(app) navigator.notification.alert('Vous ne pouvez obtenir de transport pour personne à mobilité réduite (TPMR)car, il semblerait qu\'aucun vehicule de ce type ne se trouve dans cette zone, désolé.', alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert('Vous ne pouvez obtenir de transport pour personne à mobilité réduite (TPMR)car, il semblerait qu\'aucun vehicule de ce type ne se trouve dans cette zone, désolé.');
					$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
				}
				else {
					if(app) navigator.notification.alert("Aucun taxi trouvé dans la zone réglementée sans frais d'approche.\nVous allez être redirigé.", alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert("Aucun taxi trouvé dans la zone réglementée sans frais d'approche.\nVous allez être redirigé.");
					idcourse=''; // reset idcourse
					$('#map_open').gmap('destroy');
					setTimeout( function () {
						$.mobile.pageContainer.pagecontainer("change", "#map_page", { transition: "slide"} );
					}, 1000);
				}
			}
		}, "xml").done(function() { $.mobile.loading( "hide" ); });
		refreshOpenMarkers = setInterval( function () {
			openAvail = false;
			once = true; // we only trigger the first marker
			for(k=0;k<=countMarkerCab;k++) {
				markerCab = mapEvent.get('markers')[k];
				markerCab.setVisible(false);
			}
			$.post('http://www.mytaxiserver.com/appserver/open_app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, pmr: pmr, pet: pet, group: group, dep: dep, zip: zip, pass: 'true'}, function(xml){
				//navigator.notification.alert('IN');
				$(xml).find('marker').each(function(){
					var cabid = $(this).attr('cabid');
					var name = $(this).attr('name');
					var appname = $(this).attr('appname');
					var address = $(this).attr('address');
					var licence = $(this).attr('taxi');
					var rating = $(this).attr('rating');
					var brand = $(this).attr('constructor');
					var model = $(this).attr('model');
					var color = $(this).attr('color');
					var licence_plate = $(this).attr('licence_plate');
					var seats = $(this).attr('seats');
					var lat2 = $(this).attr('lat');
					var lng2 = $(this).attr('lng');
					var timestamp = $(this).attr('timestamp');
					var distance = $(this).attr('distance');
					var i = $(this).attr('count');
					//num_req = num_req+1;
					var latlng = new google.maps.LatLng(lat2, lng2);
					var display_name = 'Taxi ' + name;
					var cabIcon = 'visuels/taxi_loc_icon.png';
					var otherCabIcon = 'visuels/not_taxi_loc_icon.png';
					var url = 'taxi=' + name + '&tel=' + address + '&cabid=' + cabid + '&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&appname=' + appname + '&dep='+dep+'&group=1&ack=0&db=1';
					//url = 'rdvpoint=' + rdvpoint + '&operator=' + operator + '&lat=' + rdvlat + '&lng=' + rdvlng + '&cell=' + cell + '&appname=' + appname + '&cabid=' + cabid + '&dep='+dep+'&group=1&ack=0&db=1';
					url = url.replace(/'/g, "&rsquo;");
					url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
					if(appname=="montaxi") {
						var mymarker = mapEvent.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': name, 'icon': cabIcon }).click(function() {
							infoCont = '<div id="infoCont"><ul style="color:#333;"><b><li>Taxi Num&eacute;ro : '+licence+'</li><li>Distance : '+parseFloat(distance).toFixed(1) + ' Km de vous</li><li>Marque : '+brand+'</li><li>Mod&egrave;le : '+model+'</li><li>Couleur : '+color+'</li><li>Places : '+seats+'</li><li>Note : '+rating+' / 5</li><li>Imatriculation : '+licence_plate+'</li></b></ul></div>';
							callBtn='<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>';
							//mapEvent.openInfoWindow({ 'content':  infoCont}, this);
							mapEvent.openInfoWindow({ 'content':  infoCont+callBtn}, this);
						});
						if(once) {
							new google.maps.event.trigger(mymarker[0],'click');
							once = false; // we only trigger the first
						}
					}
					else {
						mapEvent.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': name, 'icon': otherCabIcon }).click(function() {
							infoCont = '<div id="infoCont"><ul style="color:#333;"><b><li>Taxi Num&eacute;ro : '+licence+'</li><li>Distance : '+parseFloat(distance).toFixed(1) + ' Km de vous</li><li>Marque : '+brand+'</li><li>Mod&egrave;le : '+model+'</li><li>Couleur : '+color+'</li><li>Places : '+seats+'</li><li>Note : '+rating+' / 5</li><li>Imatriculation : '+licence_plate+'</li></b></ul></div>';
							callBtn='<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>';
							//mapEvent.openInfoWindow({ 'content':  infoCont}, this);
							mapEvent.openInfoWindow({ 'content':  infoCont+callBtn}, this);
						});
					}
					openAvail = true; // There is at least one available cab here
					countMarkerCab = i;
					//mapEvent.addBounds(latlng);
					//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
					//$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJobOpen(\''+ url +'\')" />'));
					//$('#dblinks').append($('<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>'));
					//$('#infoCont').append($('<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check cabs" id="' + i + '" onClick="sendJobOpen(\''+ url +'\')">Choisir</button>'));
				});
				if(!openAvail) {
					// special_need_vehicle needs the opendata...
					if ($('#Pmr').val()=='special_need_vehicle') {
						if(app) navigator.notification.alert('Vous ne pouvez obtenir de transport pour personne à mobilité réduite (TPMR)car, il semblerait qu\'aucun vehicule de ce type ne se trouve dans cette zone, désolé.', alertDismissed, 'Mon Appli Taxi', 'OK');
						else alert('Vous ne pouvez obtenir de transport pour personne à mobilité réduite (TPMR)car, il semblerait qu\'aucun vehicule de ce type ne se trouve dans cette zone, désolé.');
						$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
					}
					else {
						if(app) navigator.notification.alert("Aucun taxi trouvé dans la zone réglementée sans frais d'approche.\nVous allez être redirigé.", alertDismissed, 'Mon Appli Taxi', 'OK');
						else alert("Aucun taxi trouvé dans la zone réglementée sans frais d'approche.\nVous allez être redirigé.");
						idcourse=''; // reset idcourse
						$('#map_open').gmap('destroy');
						setTimeout( function () {
							$.mobile.pageContainer.pagecontainer("change", "#map_page", { transition: "slide"} );
						}, 1000);
					}
				}
			}, "xml").done(function() { $.mobile.loading( "hide" ); });
		}, 30000); 
		/*
		if(openAvail) {
			setTimeout( function () {
				var markerFav = mapEvent.get('markers')['favorite'];
				markerFav.trigger('click');
			}, 2000);
		}
		//$.mobile.loading( "hide" );
		if(i==0) {
			if(app) navigator.notification.alert('Aucun taxis touvé', alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert('AUCUN TAXI TROUVE !!');
			document.location.href='index.html';
		}*/
	}// ENDS FUNCTION

	function searchLocationsNearNoMap(centerLat, centerLng) {
		var myDate = new Date();
		idcourse = myDate.getTime();
		//$('#dblinks').append($('<input id="idcourse" type="hidden" value="' + idcourse + '"/>'));
		//var radius = document.getElementById('radiusSelect').value;
		company = $.localStorage.getItem('company');
		var rdvpoint = document.getElementById("addressInput").value;
		var room = document.getElementById("Accurate").value;
		operator = $.localStorage.getItem('operator');
		var hostname = document.getElementById("hostname").value;
		var howMany = document.getElementById("howMany").value;
		var typecar = document.getElementById("CarType").value;
		var cb = document.getElementById("Pay").value;
		var group = document.getElementById("group").value;
		var pet = document.getElementById("Pet").value;
		var pets = 'Non';
		if(pet=='pet_accepted') pets = 'Oui';
		switch (cb) {
			case '0':
				var payment = "Non";
				cb = 0;
			  break;
			case '1':
				var payment = "Oui";
				cb = 1;
			  break;
			case '2':
				var payment = "Oui (AMEX)";
				cb = 1;
			  break;
			default:
				var payment = "Non";
				cb = 0;
		}
		var coms = document.getElementById("coms").value;
		var comments1 = '<ul>' + company + '<li>Nom du client : ' + room + '</li><li>Paiement CB : ' + payment + '</li><li>Nombre de passagers : ' + howMany + '</li><li>Type de vehicule : ' + typecar + '</li><li>Animaux : ' + pets + '</li>';
		if (coms != '') {
			var comments2 = '<li>' + coms + '</li></ul>';
		}
		else {
			var comments2 = '</ul>';
		}
		var comments = comments1+comments2;
		var dest = document.getElementById("DestAddress").value;
		var cell = document.getElementById("cellular").value;
		var when = document.getElementById("when").value;
		var date = document.getElementById("date").value;
		//var medic = document.getElementById("medic").value;
		if (!dontReg) {
			for(n=1;n<4;n++) {
				if(($.localStorage.getItem('regName'+n) == null) && ($.localStorage.getItem('regCell'+n) == null)) {
					var regName = $.localStorage.setItem('regName'+n, $('#Accurate').val());
					var regCell = $.localStorage.setItem('regCell'+n, cell);
					var regLast = $.localStorage.setItem('regLast', n);
					var writen = true;
					break;
				}
			}
			if(!writen) {
				var regLast = $.localStorage.getItem('regLast');
				switch (regLast) {
					case '1':
						var entry = 2;
					  break;
					case '2':
						var entry = 3;
					  break;
					case '3':
						var entry = 1;
					  break;
					default:
				}
				var regName = $.localStorage.setItem('regName'+entry, $('#Accurate').val());
				var regCell = $.localStorage.setItem('regCell'+entry, cell);
			}
		}
		var rdvlat = centerLat;
		var rdvlng = centerLng;
		url = '';
		num_req = idcourse;
		dep = $.sessionStorage.getItem('dep');
		i = 0; // We need to make any numreq unique on that one !!
		//$.post("https://www.mytaxiserver.com/appserver/app_dcvp_xml.php", { lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, group: '1', dep: '', pass: 'true'}, function(xml){
		$.post('http://www.mytaxiserver.com/appserver/app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, group: group, dep: dep, zip: zip, insee: insee, pass: 'true'}, function(xml){
			$(xml).find('marker').each(function(){
				var name = $(this).attr('name');
				var address = $(this).attr('address');
				var lat2 = $(this).attr('lat');
				var lng2 = $(this).attr('lng');
				var timestamp = $(this).attr('timestamp');
				var distance = $(this).attr('distance');
				i = $(this).attr('count');
				num_req = num_req+1;
				url = 'taxi=' + name + '&tel=' + address + '&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&dep='+dep+'&group=1&ack=0&db=1&prix=20000';
				url = url.replace(/'/g, "&rsquo;");
				url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
				//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
				$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJob(\''+ url +'\')" />'));
			});
			num_req = num_req+1;
			i = parseInt(i,10)+1;
			url = 'taxi=0000&tel=0000000000&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&dep='+dep+'&group=1&ack=0&db=1&prix=20000';
			//navigator.notification.alert(url);
			url = url.replace(/'/g, "&rsquo;");
			url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
			// Sends Auction Request to TaxiMedia appserver
			$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJob(\''+ url +'\')" />'));
			//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
		}, "xml").fail(function (jqXHR, textStatus, errorThrown) {
				navigator.notification.alert('Erreur inconnue, le serveur ou la connexion internet sont indisponibles. ' + textStatus+', '+ errorThrown, alertDismissed, 'Mon Appli Taxi Erreur', 'OK');
		});
		$.mobile.loading( "hide" );
		$('#dblinks').append($('<input id="stop" type="hidden" value="0" />'));
		deliver();
	}// ENDS FUNCTION
	
	function searchLocationsNear(center, mapEvent) {
		//clearLocations();
		//navigator.notification.alert('In searchLocationsNear');
		$('#map').gmap('refresh');
		var myDate = new Date();
		idcourse = myDate.getTime();
		//$('#dblinks').append($('<input id="idcourse" type="hidden" value="' + idcourse + '"/>'));
		//var radius = document.getElementById('radiusSelect').value;
		company = $.localStorage.getItem('company');
		var rdvpoint = document.getElementById("addressInput").value;
		var room = document.getElementById("Accurate").value;
		operator = $.localStorage.getItem('operator');
		var hostname = document.getElementById("hostname").value;
		var howMany = document.getElementById("howMany").value;
		var typecar = document.getElementById("CarType").value;
		var cb = document.getElementById("Pay").value;
		var group = document.getElementById("group").value;
		switch (cb) {
			case '0':
				var payment = "Non";
				cb = 0;
			  break;
			case '1':
				var payment = "Oui";
				cb = 1;
			  break;
			case '2':
				var payment = "Oui (AMEX)";
				cb = 1;
			  break;
			default:
				var payment = "Non";
				cb = 0;
		}
		var coms = document.getElementById("coms").value;
		var comments1 = '<ul>' + company + '<li>Nom du client : ' + room + '</li><li>Paiement CB : ' + payment + '</li><li>Nombre de passagers : ' + howMany + '</li><li>Type de vehicule : ' + typecar + '</li>';
		if (coms != '') {
			var comments2 = '<li>' + coms + '</li></ul>';
		}
		else {
			var comments2 = '</ul>';
		}
		var comments = comments1+comments2;
		var dest = document.getElementById("DestAddress").value;
		var cell = document.getElementById("cellular").value;
		var when = document.getElementById("when").value;
		var date = document.getElementById("date").value;
		//var medic = document.getElementById("medic").value;
		if (!dontReg) {
			for(n=1;n<4;n++) {
				if(($.localStorage.getItem('regName'+n) == null) && ($.localStorage.getItem('regCell'+n) == null)) {
					var regName = $.localStorage.setItem('regName'+n, $('#Accurate').val());
					var regCell = $.localStorage.setItem('regCell'+n, cell);
					var regLast = $.localStorage.setItem('regLast', n);
					var writen = true;
					break;
				}
			}
			if(!writen) {
				var regLast = $.localStorage.getItem('regLast');
				switch (regLast) {
					case '1':
						var entry = 2;
					  break;
					case '2':
						var entry = 3;
					  break;
					case '3':
						var entry = 1;
					  break;
					default:
				}
				var regName = $.localStorage.setItem('regName'+entry, $('#Accurate').val());
				var regCell = $.localStorage.setItem('regCell'+entry, cell);
			}
		}
		var rdvlat = center.lat();
		var rdvlng = center.lng();
		url = '';
		num_req = idcourse;
		dep = $.sessionStorage.getItem('dep');
		i = 0; // We need to make any numreq unique on that one !!
		//$.post('https://www.mytaxiserver.com/appserver/app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, group: group, dep: dep, zip: zip, pass: 'true'}, function(xml){
		$.post('http://www.mytaxiserver.com/appserver/app_dcvp_xml.php', {lat: rdvlat, lng: rdvlng, type: typecar, howmany: howMany, cb: cb, group: group, dep: dep, zip: zip, pass: 'true'}, function(xml){
			//navigator.notification.alert('IN');
			$(xml).find('marker').each(function(){
				var name = $(this).attr('name');
				var address = $(this).attr('address');
				var lat2 = $(this).attr('lat');
				var lng2 = $(this).attr('lng');
				var timestamp = $(this).attr('timestamp');
				var distance = $(this).attr('distance');
				i = $(this).attr('count');
				num_req = num_req+1;
				var latlng = new google.maps.LatLng(lat2, lng2);		
				var display_name = 'Taxi ' + name;
				var cabIcon = 'visuels/taxi_loc_icon.png';
				mapEvent.addMarker({ id: i ,'position': latlng, 'bounds': true, 'title': display_name, 'icon': cabIcon }).click(function() {
					infoCont = '<p style="color:#333;"><b>taxi n&deg; ' + name + ' est &agrave; ' + parseFloat(distance).toFixed(1) + ' Km de vous tel: ' + address+ '</b></p>';
					mapEvent.openInfoWindow({ 'content':  infoCont}, this);
				});
				//mapEvent.addBounds(latlng);
				url = 'taxi=' + name + '&tel=' + address + '&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&dep='+dep+'&group=1&ack=0&db=1&prix=20000';
				url = url.replace(/'/g, "&rsquo;");
				url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
				//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
				$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJob(\''+ url +'\')" />'));
			});
			num_req = num_req+1;
			i = parseInt(i,10)+1;
			url = 'taxi=0000&tel=0000000000&idcourse=' + idcourse + '&num_req=' + num_req + '&rdvpoint=' + rdvpoint + '&lat=' + rdvlat + '&lng=' + rdvlng + '&comments=' + comments + '&cell=' + cell + '&when=' + when + '&date=' + date + '&operator=' + operator + '&dep='+dep+'&group=1&ack=0&db=1&prix=20000';
			url = url.replace(/'/g, "&rsquo;");
			url = url.replace(/(?:\r\n|\r|\n)/g, '<br/>'); // Replaces line breaks by <br/>
			// Sends Auction Request to TaxiMedia appserver
			$('#dblinks').append($('<input class="cabs" id="' + i + '" type="hidden" onclick="sendJob(\''+ url +'\')" />'));
			//$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
		}, "xml").fail(function (jqXHR, textStatus, errorThrown) {
				navigator.notification.alert('Erreur inconnue, le serveur ou la connexion internet sont indisponibles. ' + textStatus+', '+ errorThrown, alertDismissed, 'Mon Appli Taxi Erreur', 'OK');
		});
		$.mobile.loading( "hide" );
		$('#dblinks').append($('<input id="stop" type="hidden" value="0" />'));
		deliver();
	}// ENDS FUNCTION


    function deliver()
    {	
        //$("a.load").trigger('click');
        var GoOn = setTimeout( function () {
            $("#deliver").trigger('click');
        }, 2000);
    }
	
    function sendJobOpen(url)
    {
		$.mobile.loading( "show" );
		$('.cabs').prop('disabled', true).addClass('ui-disabled'); // Prevents from multitap
		$('.confButtons').hide('fast');
		$('.whatNext').hide('fast');
		$('#answerOpen').empty().append('<p><b>Veuillez patienter pendant que nous traitons votre demande aupr&egrave;s du chauffeur ...<button type="button" class="cancel ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-left ui-icon-delete" id="cancel" onClick="stopCallOpen()" value=""> Retour / Annulation </button></b></p>');
		$.post("http://www.mytaxiserver.com/appserver/open_diary_app_share.php", url, function(data) {
			hail_id = data.hail_id;
			//taxi_phone_number = data.taxi_phone_number;
		}, "json").done(function() { 
			if(hail_id!="") setTimeout('check_answer_open()', 1000);
			clearInterval(refreshOpenMarkers);
			//check_answer_open();
		}).always(function(data) {
			$.mobile.loading( "hide" );
		}).fail(function() { 
			if(app) navigator.notification.alert("Erreur: La demande n'a pas été envoyée, vous allez devoir recommencer, veuillez nous pardonner ce contretemps.", alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert("Erreur: La demande n'a pas été envoyée, vous allez devoir recommencer, veuillez nous pardonner ce contretemps.");
			document.location.href='index.html';
		});
    }
	
    function check_answer_open()
    {
		//dep = $.sessionStorage.getItem('dep');
		if(answerBoxOpenPoped==0) {
			$( "#answerBoxOpen" ).popup( "open", { positionTo: "window" } );
			answerBoxOpenPoped=1;
		}
		if(!stopCheckAnswer) {
			$.ajax({
				type: "GET",
				url: "http://www.mytaxiserver.com/appserver/open_status_json_lp.php?hail_id=" + hail_id + "&dep=" + dep + "&check=1",
				data: { hail_id: hail_id, dep: dep, check: 1 },
				dataType: "json",
				cache: false,
				timeout: 60000 // in milliseconds
			}).done(function(data) {
				if (data.display != 0)
				{
					//clearInterval(time);
					//clearTimeout(endcourse);
					//cancel(idcourse);
					//document.getElementById('stop').value = 1;
					//var box = navigator.notification.alert(data.display);
					//stopCallOpen();
					//$('#thanksResults').empty().append(data.display);
					$('#answerOpen').empty().append(data.display);
					if(data.status == "accepted_by_taxi") {
						if(!stopCheckAnswer) $('.confButtons').show('fast'); // Avoid to show it twice as first if(!stopCheckAnswer) event is before the AJAX call and here is after completion
					}
					else {
						$('.whatNext').empty().append('<button onClick="refreshApp()" class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-home">Revenir &agrave; l&rsquo;accueil</button>');
						$('.whatNext').show('fast');
					}
					//$( "#answerBoxOpen" ).popup( "open", { positionTo: "window" } );
					if(notifyOnce) {
						notifyOnce = false;
						badgeNumber = 1;
						//toNotify = data.split("<", 1);
						toNotify = data.display;
						cordova.plugins.notification.local.schedule({
							id: 1,
							title: "Mon Appli Taxi",
							text: toNotify,
							led: "E7B242",
							badge: badgeNumber,
							data: { data:toNotify }
						});
						playAudio('sounds/ring.mp3');
					}
					//stopCheckAnswer=true;
					//return false;
				}
				else {
					notifyOnce = true;
				}
			}).always(function(data) {
				setTimeout('check_answer_open()', 1000);
			});
		}
    }

    function cancelOpen(idcourse)
    {
		//navigator.notification.alert(idcourse);
		dep = $.sessionStorage.getItem('dep');
		if(hail_id!='') {
			$.post("http://www.mytaxiserver.com/appserver/open_diary.php?hail_id=" + hail_id + "&ack=1&db=1&cab_wont=1&del=1&status=declined_by_customer"); 
		}
    }        
	function stopCallOpen()
	{
		//$.mobile.loading( "show" );
		//$('#dblinks').empty();
		//clearInterval(time);
		clearInterval(refreshOpenMarkers);
		//clearTimeout(endcourse);
		cancelOpen(idcourse);
		//$('#map').gmap('destroy');
		$('#map_open').gmap('destroy');
		$( "#backPopOpen" ).popup( "open", { positionTo: "window" } );
		var wait2getBack = setTimeout( function () {
			document.location.href='index.html';
			//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
		}, 2000);
	}
    function sendJob(url)
    {	
		$.post("https://www.mytaxiserver.com/appserver/diary_app_share.php", url, function(data) {});
    }
	
    function check_answer()
    {
		clearInterval(refreshOpenMarkers);
		dep = $.sessionStorage.getItem('dep');
		if(!stopCheckAnswer) {
			$.ajax({
				type: "GET",
				url: "http://www.mytaxiserver.com/appserver/status_lp.php?hail_id=" + hail_id + "&dep=" + dep + "&check=1",
				data: { idcourse: idcourse, dep: dep, check: 1 },
				dataType: "html",
				cache: false,
				timeout: 60000 // in milliseconds
			}).done(function(data) {
				if (data != 0)
				{
					clearInterval(time);
					clearTimeout(endcourse);
					cancel(idcourse);
					document.getElementById('stop').value = 1;
					//var box = navigator.notification.alert(data);
					//stopCall();
					//var box = navigator.notification.alert(data);
					//$('#thanksResults').empty().append(data);
					$('#answer').empty().append(data);
					$( "#answerBox" ).popup( "open", { positionTo: "window" } );
					if(notifyOnce) {
						notifyOnce = false;
						badgeNumber = 1;
						toNotify = data.split("<", 1);
						cordova.plugins.notification.local.schedule({
							id: 1,
							title: "Mon Appli Taxi",
							text: toNotify,
							led: "E7B242",
							badge: badgeNumber,
							data: { data:toNotify }
						});
						playAudio('sounds/ring.mp3');
					}
					stopCheckAnswer=true;
					//return false;
				}
				else {
					notifyOnce = true;
				}
			}).always(function(data) {
				setTimeout('check_answer()', 2000);
			});
		}
    }
    function cancel(idcourse)
    {
		//navigator.notification.alert(idcourse);
		dep = $.sessionStorage.getItem('dep');
        $.post("https://www.mytaxiserver.com/appserver/diary.php?idcourse=" + idcourse + "&dep=" + dep +"&ack=1&db=1&cab_wont=1&del=1"); 
    }        
	function stopCall()
	{
		//$.mobile.loading( "show" );
		$('#dblinks').empty();	 
		clearInterval(time);
		clearInterval(refreshOpenMarkers);
		clearTimeout(endcourse);
		cancel(idcourse);
		idcourse=''; // reset idcourse
		$('#map').gmap('destroy');
		$( "#backPop" ).popup( "open", { positionTo: "window" } );
		var wait2getBack = setTimeout( function () {
			document.location.href='index.html';
			//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
		}, 1000);
	}
    function goback(flag)
    {
		$('#dblinks').empty();	 
		clearInterval(refreshOpenMarkers);
		clearInterval(time);
		clearTimeout(endcourse);
		idcourse=''; // reset idcourse
		//$('#map').gmap('destroy');
		//$('#follow_map').gmap('destroy');
        document.location.href=flag;
		//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
    }        
    function gobackOpen(flag, action)
    {
		//$('#dblinks').empty();
		idcourse=''; // reset idcourse
		stopCheckAnswer=true;
		answerBoxOpenPoped=0;
		$('#answerOpen').empty().append('<p><b>Veuillez patienter un instant SVP</b></p>');
		$('.confButtons').hide('fast');
		if(action==1) {
			// Client Agrees...
			//$.post("https://www.mytaxiserver.com/appserver/open_diary.php?hail_id=" + hail_id + "&lat=" + lat + "&lng=" + lng + "&ack=1&db=1&cab_wont=0&del=0&status=accepted_by_customer").done(function(data) {
			$.post("http://www.mytaxiserver.com/appserver/open_diary.php?hail_id=" + hail_id + "&lat=" + lat + "&lng=" + lng + "&cell=" + tel + "&operator=" + operator + "&dep=" + dep + "&ack=1&db=1&cab_wont=0&del=0&status=accepted_by_customer").done(function(data) {
				//$('.whatNext').empty().append('<p><b>Vous avez accept&eacute; la course, le chauffeur se rend sur place, un mail vous a &eacute;t&eacute; envoy&eacute; et vous allez &ecirc;tre redirig&eacute; vers l&rsquo;accueil.</b></p>');
				$('#answerOpen').empty().append('<p><b>Le chauffeur va maintenant vous rejoindre, voici les actions disponibles:</b></p>');
				$('.whatNext').empty().append(data);
				$('.whatNext').show('fast');
				//stopCheckAnswer=false;
				/*
				setTimeout(function() { 
					document.location.href=flag;
				}, 6000);
				*/
			});
		}
		else {
			// Client Abort...
			//$.post("https://www.mytaxiserver.com/appserver/open_diary.php?hail_id=" + hail_id + "&lat=" + lat + "&lng=" + lng + "&ack=1&db=1&cab_wont=1&del=1&status=declined_by_customer").done(function(data) {
			$.post("http://www.mytaxiserver.com/appserver/open_diary.php?hail_id=" + hail_id + "&lat=" + lat + "&lng=" + lng + "&cell=" + tel + "&operator=" + operator + "&dep=" + dep + "&ack=1&db=1&cab_wont=1&del=1&status=declined_by_customer").done(function(data) {
				$('#answerOpen').empty();
				$('.whatNext').empty().append('<p><b>Vous avez refus&eacute; la course et allez &ecirc;tre redirig&eacute; vers l&rsquo;accueil.</b></p>');
				$('.whatNext').show('fast');
				//stopCheckAnswer=false;
				setTimeout(function() { 
					document.location.href=flag;
				}, 1000);
			});
		}
    }
	function callIncident(irdv, ihail, iop, icell, istatus)
	{ // callIncident(\''.$rdv.'\', \''.$hail_id.'\', \''.$operator.'\', \''.$cell.'\', \''.$status.'\')
		$.post("https://www.mytaxiserver.com/appserver/open_incident.php" , { rdvpoint: irdv, hail_id: ihail, operator: iop, cell: icell, status: istatus, db: 'true', dep: dep}, function(data){ 
			if (data.ok)
			{
				var number = data.taxi_phone_number;
				var message = "Suite à un incident, je ne pourrais vous attendre.";
				var options = {
					replaceLineBreaks: false, // true to replace \n by a new line, false by default
					android: {
						intent: 'INTENT'  // send SMS with the native android SMS messaging
						//intent: '' // send SMS without open any other app
					}
				};
				var success = function () {
				};
				var error = function (e) {
					if(app) navigator.notification.alert("L'incident a été déclaré toutefois, votre appareil semble ne pas gérer les sms, veuillez contacter le chauffeur pour l'avertir SVP.", alertDismissed, 'Mon Appli Taxi', 'OK');
					else alert("L'incident a été déclaré toutefois, votre appareil semble ne pas gérer les sms, veuillez contacter le chauffeur pour l'avertir SVP.");
				};
				sms.send(number, message, options, success, error);
				//$.mobile.pageContainer.pagecontainer("change", "#infos", { transition: "slide"} );
				//return false;
			}
			else {
				if(app) navigator.notification.alert("Erreur: L'incident n'a pas été déclaré.", alertDismissed, 'Mon Appli Taxi', 'OK');
				else alert("Erreur: L'incident n'a pas été déclaré.");
			}
		}, "json");
	}
	function getPrices()
	{
		var rdvPrices = $('#addressInputPrices').val();
		var destPrices = $('#DestAddressPrices').val();
		$('#addressInput').val(rdvPrices); // regarding the command button.
		var rdvPricesLng;
		var rdvPricesLat;
		var destPricesLng;
		var destPricesLat;
		if (rdvPrices!='' && destPrices!='') {
			// Using http://adresse.data.gouv.fr
			//http://api-adresse.data.gouv.fr/search/?q=8 bd du port&type=street
			$.get('http://api-adresse.data.gouv.fr/search/', {q: rdvPrices, type: ''}, function(data) {
				rdvPricesLng = data.features[0].geometry.coordinates[0];
				rdvPricesLat = data.features[0].geometry.coordinates[1];
			}, "json").done(function(data) { 
				$.get('http://api-adresse.data.gouv.fr/search/', {q: destPrices, type: ''}, function(data) {
					destPricesLng = data.features[0].geometry.coordinates[0];
					destPricesLat = data.features[0].geometry.coordinates[1];
				}, "json").done(function(data) { 
					var devUrl = 'lat=' + rdvPricesLat + '&lng=' + rdvPricesLng + '&lat2=' + destPricesLat + '&lng2=' + destPricesLng + '&rdv=' + rdvPrices + '&dest=' + destPrices + '&dep=' + dep+ '&app=1';
					//alert(devUrl);
					$.post("http://www.mytaxiserver.com/appserver/calcdev.php", devUrl, function(data) { 
						$('#pricesCont').empty().append(data+'<button onClick="checkZip(\'#map_page_open\')" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-action" id="search">Commander maintenant</button>');
						//$('#pricesPopCont').empty().append(data);
						//$( "#pricesPop" ).popup( "open", { positionTo: "window" } );
					});
				});
			});
		}
		else {
			if(app) navigator.notification.alert("Vous devez rensigner les adresses de départ et d'arrivée.", alertDismissed, 'Mon Appli Taxi', 'OK');
			else alert("Vous devez rensigner les adresses de départ et d'arrivée.");
		}
	}
    function refreshApp()
    {
		document.location.href='index.html';
    }
	function playAudio(src) {
		if (my_media == null) {
			// Create Media object from src
			var path = window.location.pathname;
			path = path.substring(0, path.lastIndexOf('/') + 1);
			var source = path + src;
			my_media = new Media(source, playOnSuccess, playOnError);
		}
		// Play audio
		my_media.play();
	} 
	// Stop audio
	function stopAudio() {
		if (my_media) {
			my_media.stop();
		}
	}
	// onSuccess Callback
	function playOnSuccess() {
		//console.log("playAudio():Audio Success");
	}
	// onError Callback 
	function playOnError(error) {
		//navigator.notification.alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
	}
	/*
	$('#infos').live("swiperight", function() {
		$("#panel_poper").trigger('click');
	});
	*/
    </script>
    </head>
    <body style="margin:0px; padding:0px;">
    <div data-role="panel" id="homepanel" data-position="right" data-display="reveal">
        <!-- panel content goes here -->
        <ul data-role="listview" data-inset="true" data-theme="c">
          <li><a href="#infos" class="ui-btn ui-btn-icon-left ui-icon-home" data-transition="slide"><b>Commander</b></a></li>
          <li><a href="#prices" class="ui-btn ui-btn-icon-left ui-icon-info" data-transition="slide"><b>Tarification</b></a></li>
          <li><a href="#history" class="ui-btn ui-btn-icon-left ui-icon-bars" data-transition="slide">Historique</a></li>
          <li><a href="#account" class="ui-btn ui-btn-icon-left ui-icon-user" data-transition="slide">Mon compte</a></li>
          <!-- 
          <li><a href="#fleet_page" class="ui-btn ui-btn-icon-left ui-icon-eye">Taxis disponibles</a></li>
		  <li><a href="#" onClick="Share()" class="ui-btn ui-btn-icon-left ui-icon-mail noAppHide"><b>Partager l&rsquo;app</b></a></li>
		  <li><a href="#" onclick="window.plugins.socialsharing.share('Téléchargez Mon Appli Taxi sur taximedia.fr', null, 'http://www.taximedia.fr/icon_300.png', 'http://www.taximedia.fr/stores.php?app=taxioff')" class="ui-btn ui-btn-icon-left ui-icon-mail noAppHide"><b>Partager l&rsquo;app</b></a></li>
		   -->
 		  <li><a href="#" onclick="window.plugins.socialsharing.share('Téléchargez Mon Appli Taxi Business sur taximedia.fr', null, null, 'http://www.taximedia.fr/stores.php?app=taxipro')" class="ui-btn ui-btn-icon-left ui-icon-mail noAppHide"><b>Partager l&rsquo;app</b></a></li>
          <li><a href="#" onClick="goScan()" data-transition="slide" class="ui-btn ui-btn-icon-left ui-icon-camera noAppHide">Scanner un code</a></li>
        </ul>
        <button class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-power" onClick="dc()">D&eacute;connexion</button>
		<div id="getBackDriver"></div>
    </div><!-- /panel -->
    <div data-role="page" data-theme="c"  id="infos">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="34%"></th><th width="16%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#homepanel" id="panel_poper" data-role="none" style="width:90%;">
						<img src="visuels/ico_menu.png" width="100%" style="max-width:175px;"/>
					</a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <center>
            <div style="margin-top:1em; display:block;">
                <!-- <img src="visuels/logo.png" width="60%" style="margin-bottom:-0.6em; max-width:252px"/> -->
                <input type="hidden" id="operator" size="40" value="0"/>
                <input type="hidden" id="hostname" size="40" value=""/>
                <input type="hidden" id="group" size="16" value="1"/>
                <input type="hidden" id="exclu" size="1" value="0"/>
                <input type="hidden" id="goFavs" size="1" value="0"/>
                <table width="100%" border="0">
                	<thead><tr><th width="90%"></th><th width="10%"></th></tr></thead>
                    <tbody>
                	<tr><td>
                        <input type="text" id="addressInput" data-clear-btn="true" size="40" placeholder="Adresse RDV" width="90%" style="min-height:3em;"/>
                    </td><td align="center">
						<img src="visuels/ico_geolocalisation.png" width="100%" class="cursor" onClick="locateMe()" style="max-width:40px;"/>
                        <!-- <button onClick="locateMe()" class="ui-btn ui-btn-c ui-icon-location ui-shadow-icon ui-btn-icon-notext ui-corner-all"></button> -->
                    </td></tr>
                <input type="hidden" id="DestAddress" size="10" value="DESTINATION"/>
                	<tr><td>
                        <input type="text" id="Accurate" data-clear-btn="true" class="mustHave" size="32" placeholder="Nom *" style="min-height:3em;"/>
                    </td><td align="center">
						<img src="visuels/ico_modif.png" width="100%" class="cursor" onClick="getContact()" style="max-width:45px;"/>
                        <!-- <button onClick="getContact()" class="ui-btn ui-btn-c ui-icon-edit ui-shadow-icon ui-btn-icon-notext ui-corner-all"></button> -->
                    </td></tr>
                	<tr><td>
                        <input type="tel" id="cellular" data-clear-btn="true" class="mustHave" size="20" placeholder="Tel *" style="min-height:3em;"/>
                    </td><td align="center">
                        <a href="#rememberMe" data-rel="popup" data-position-to="window">
							<img src="visuels/ico_favori.png" width="100%" class="cursor" style="max-width:50px;"/>
						</a>
                    </td></tr>
                    </tbody>
                </table>
                <!-- <p style="font-size:small;"><em>*</em> Ces informations sont obligatoires</p> -->
                <p class="expends"><b>Un besoin particulier ?</b><br><img src="visuels/dots.png" width="100%" style="max-width:1200px;"/></p>
                <div id="details">
                    <label for="howMany">Nombre de passagers :</label>
                    <input name="howMany" id="howMany" min="1" max="20" value="1" data-theme="c" data-show-value="true" data-popup-enabled="true" type="range">
                    <select id="CarType"> 
                        <option value="Berline" selected>Vehicule</option>
                        <option value="Berline">Berline</option>
                        <option value="Break">Break</option>
                        <option value="Van">Monospace</option>
                    </select>
                    <!-- 
                    <select id="medic"> 
                        <option value="0" selected>Conventionn&eacute;</option>
                        <option value="0">Non</option>
                        <option value="1">Oui</option>
                    </select>
                    -->
                    <select id="Pay"> 
                        <option value="" selected>CB / AMEX</option>
                        <option value="0">Aucun</option>
                        <option value="1">CB</option>
                        <option value="2">AMEX</option>
                    </select>
				   <select id="Pmr"> 
						<option value="" selected>TPMR</option>
						<option value="special_need_vehicle">OUI</option>
						<option value="">NON</option>
					</select>
					<select id="Pet"> 
						<option value="" selected>Animaux</option>
						<option value="pet_accepted">OUI</option>
						<option value="">NON</option>
					</select>
                    <textarea id="coms" placeholder="Commentaires"></textarea>
                </div>
                <p class="expends"><b>Pour plus tard ?</b><br><img src="visuels/dots.png" width="100%" style="max-width:1200px;"/></p>
                <div id="book">
                    <p id="datelabel"><b>Date et heure du RDV si r&eacute;servation :</b></p>
                    <span style="display:inline-block;width: 48%;">
                        <input type="date" id="date" placeholder="jj/mm/aaaa" data-inline="true" value=""/>
                    </span>
                    <span style="display:inline-block;width: 48%;">
                        <input type="time" id="when" placeholder="hh:mm" data-inline="true" value=""/>
                    </span>
                </div>
                <input type="hidden" id="radiusSelect" value="100" />
                <p>&nbsp;</p>
                <div id="next-box"><button id="next" class="ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-left ui-icon-next">* Champs obligatoires</button></div>
                <div id="search-box">
					<div id="openDep-box">
						<button onClick="checkZip('#map_page_open')" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-search" id="searchOpen">Choisir un taxi</button>
						<p><a href="#" onClick="openSomeUrl('http://le.taxi/')">La maraude &eacute;lectronique avec Le.Taxi &ccedil;a change quoi ?</a></p>
					</div>
					<!--
					<div id="tm-box">
						<button onClick="checkZip('#map_page')" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-action" id="search">Commander un taxi</button>
					</div>
					-->
				</div>
                <div id="book-box"><button onClick="booking()" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-clock" id="booking">R&eacute;server un taxi</button></div>
                <div data-role="popup" data-theme="a" id="errorPop" data-dismissible="true">
					<a href="#infos" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Fermer</a>
                    <div data-theme="a" data-role="header">
                        <h1>
                            G&eacute;olocalisation
                        </h1>
                    </div>
                    <div class="ui-content" role="main">
                        <div id="resultsGeo"></div>
                    </div>
                </div>
                <div data-role="popup" data-theme="a" id="rememberMe" data-dismissible="true">
 					<a href="#infos" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Fermer</a>
                   <div data-theme="a" data-role="header">
                        <p style="font-size:21px;text-align:center;"><b>
                            Enregistrements
                        </b></p>
                    </div>
                    <div class="ui-content" role="main">
                        <div id="regLinks"></div>
                    </div>
                </div>
                <div data-role="popup" data-theme="a" id="setZip" data-dismissible="true">
 					<a href="#infos" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Fermer</a>
                   <div data-theme="a" data-role="header">
                        <p style="font-size:21px;text-align:center;"><b>
                            CP Commune
                        </b></p>
                    </div>
                    <div class="ui-content" role="main">
                    	<p>
                            Veuillez saisir le code postal de la commune o&ugrave; vous vous trouvez :
                            <input type="tel" id="zipDep" data-clear-btn="true" size="5"/>
                        </p>
                        <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" onClick="setZip()">Envoyer</button>
                    </div>
                </div>
            </div>
            </center>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="map_page_open">
        <div class="ui-content" role="main" id="map_open">
			<div data-role="popup" data-theme="c" id="answerBoxOpen" data-dismissible="false" data-position-to="window" data-overlay-theme="b">
				<div data-theme="c" data-role="header">
					<h1>
						Confirmation
					</h1>
				</div>
				<div class="ui-content" role="main">
					<div id="answerOpen"></div>
					<div class="confButtons">
						<input type="button" value="ACCEPTER" onClick="gobackOpen('index.html', '1')"/>
						<input type="button" value="REFUSER" onClick="gobackOpen('index.html', '0')"/>
					</div>
					<div class="whatNext"></div>
				</div>
			</div>
			<div data-role="popup" data-theme="c" id="backPopOpen" data-dismissible="false" data-position-to="window" data-overlay-theme="b">
				<div data-theme="c" data-role="header">
					<h1>
						Annulation
					</h1>
				</div>
				<div class="ui-content" role="main">
					<p><strong>
						Vous avez annul&eacute; votre demande ou 
						aucun taxis n&rsquo;a r&eacute;pondu dans le temps imparti, vous devriez rechercher de nouveau.
					</strong></p>
				</div>
			</div>
        </div>
        <div data-role="footer" id="footer_map_open" data-position="fixed" data-fullscreen="true">
			<p>Veuillez S&eacute;lectionner un des taxis ci-dessus pour le choisir
			<button type="button" class="cancel ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-left ui-icon-delete" id="cancel" onClick="stopCallOpen()" value=""> Retour / Annulation </button></p>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="map_page" >
        <!-- <div class="ui-content" role="main" id="map"> -->
        <div class="ui-content" role="main" id="no-map">
			<div id="animSearch" class="nyc">
				<p><b>
				<br><br>
				Nous recherchons le taxi disponible le plus proche de vous! Des frais d&rsquo;approches peuvent s&rsquo;appliquer, n&rsquo;h&eacute;sitez pas &agrave; les v&eacute;rifier avec le chauffeur.
				<br>
				Veuillez patienter pendant la recherche: <span class="elapsed" style="color:#FC0;"></span> Secondes restantes.
				<br><br><br>
				</b></p>
				<img src="visuels/wifi-1.png" width="64%" id="wifiSteps" class="wifiSteps"/>
			</div>
			<div data-role="popup" data-theme="c" id="answerBox" data-dismissible="false" data-position-to="window" data-overlay-theme="b">
				<div data-theme="c" data-role="header">
					<h1>
						Confirmation
					</h1>
				</div>
				<div class="ui-content" role="main">
					<div id="answer"></div>
					<input type="button" value="OK" onClick="goback('index.html')"/>
				</div>
			</div>
			<div data-role="popup" data-theme="c" id="backPop" data-dismissible="false" data-position-to="window" data-overlay-theme="b">
				<div data-theme="c" data-role="header">
					<h1>
						Annulation
					</h1>
				</div>
				<div class="ui-content" role="main">
					<p><strong>
						Vous avez annul&eacute; votre demande ou 
						aucun taxis n&rsquo;a r&eacute;pondu dans le temps imparti, vous devriez rechercher de nouveau.
					</strong></p>
				</div>
			</div>
        </div>
        <div data-role="footer" id="footer_map" data-position="fixed" data-fullscreen="true">
			<div id="deliv-hide" style="width: 0px; height: 0px; visibility:hidden;">
				<input type="button" onClick="" id="deliver" value="" />
			</div>
			<div id="left" style="width: 0px; height: 0px; visibility:hidden;">
				<div id="dblinks">
				</div>
			</div>
			<p><button type="button" class="cancel ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-left ui-icon-delete" id="cancel" onClick="stopCall()" value=""> Retour / Annulation </button></p>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="connect">
        <div class="ui-content" role="main">
            <center>
            <div style="margin-top:1em; display:block;">
				<img src="visuels/logo_montaxi.png" width="60%" style="max-width:512px;"/>
                <input type="tel" id="login" data-clear-btn="true" size="40" placeholder="Identifiant"/>
                <input type="password" id="pwd" data-clear-btn="true" size="40" placeholder="Mot de passe"/>
                <div id="loginReturns"></div>
                <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" onClick="login()">Connexion</button>
                <a href="#subscription" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-user">Nouvelle Inscription</a>
                <p style="font-size:small;"><a href="#" id="displayForgot">Mot de passe oubli&eacute;</a></p>
                <div id="forgotForm" style="display:none;">
                    <input type="tel" id="forgotTel" data-clear-btn="true" size="40" placeholder="Identifiant"/>
                    <input type="email" id="forgotMail" size="32" maxlength="60" placeholder="email"/>
                    <button class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-mail" onClick="forgottenPwd()">Envoyer</button>
                </div>
				<p>&nbsp;</p>
				<!--
                <p><a href="#" id="displayReSendText" class="expends">V&eacute;rifier mon num&eacute;ro de t&eacute;l&eacute;phone</a></p>
                <div id="reSendTextForm" style="display:none;">
					<p style="font-size:small;">Veuillez renseigner ci-dessous le num&eacute;ro de t&eacute;l&eacute;phone associ&eacute; &agrave; votre compte.</p>
                    <input type="tel" id="smsTel" data-clear-btn="true" size="40" placeholder="Tel"/>
                    <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-mail" onClick="reSendText()">Envoyer</button>
                </div>
				-->
                <p><a href="#" onClick="openSomeUrl('https://goo.gl/Bz4yK0')">Le.Taxi &ccedil;a marche comment? &Ccedil;a change quoi ?</a></p>
                <div id="fogotReturns"></div>
				<a href="mailto:info@taximedia.fr" class="ui-btn ui-btn-icon-left ui-icon-mail  ui-shadow-icon ui-corner-all">Nous contacter</a>
           </div>
            </center>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="subscription">
        <div data-role="header" data-position="fixed" class="header">
			<a href="#connect" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-back"><p style="font-size:16px"><b>Retour</b></p></a>
		</div>
        <div class="ui-content" role="main">
			<div class="cleaner"></div>
            <div style="padding:1em; display:block;">
            	<center>
				<img src="visuels/logo_montaxi.png" width="60%" style="max-width:512px;"/>
                <input type="text" id="subName" data-clear-btn="true" size="40" placeholder="Nom"/>
                <input type="email" id="subMail" data-clear-btn="true" size="40" placeholder="Email"/>
                <input type="tel" id="subTel" data-clear-btn="true" size="40" placeholder="Tel (Sans espace SVP)"/>
                <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" onClick="subscribe()">Inscription</button>
                </center>
                <div id="data"></div>
                <div id="subReturns"></div>
				<p>&nbsp;</p>
                <p><a href="#" onClick="openSomeUrl('https://goo.gl/Bz4yK0')">Le.Taxi &ccedil;a marche comment? &Ccedil;a change quoi ?</a></p>
            </div>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="account">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="34%"></th><th width="16%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#homepanel" id="panel_poper" data-role="none" style="width:90%;">
						<img src="visuels/ico_menu.png" width="100%" style="max-width:175px;"/>
					</a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <div style="padding:1em; display:block;">
            	<center>
                <input type="tel" id="accTel" data-clear-btn="true" size="40" placeholder="Tel (Sans espace SVP)"/>
                <input type="text" id="accName" data-clear-btn="true" size="40" placeholder="Nom"/>
                <input type="email" id="accMail" data-clear-btn="true" size="40" placeholder="Email"/>
                <input type="password" id="accPwd" data-clear-btn="true" size="40" placeholder="Mot de passe"/>
                <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-edit" onClick="accountMod()">Modifier</button>
                </center>
                <div id="accReturns"></div>
            </div>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="history">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="34%"></th><th width="16%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#homepanel" id="panel_poper" data-role="none" style="width:90%;">
						<img src="visuels/ico_menu.png" width="100%" style="max-width:175px;"/>
					</a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <div style="display:block;">
				<button onClick="refreshHist()" class="ui-btn ui-btn-b ui-btn-right ui-icon-refresh ui-shadow-icon ui-btn-icon-notext ui-corner-all"></button>
            	<center>
                <p style="font-size:16px;color:#FC0;"><b>Historique des courses</b><br><img src="visuels/dots.png" width="100%" style="max-width:1200px;"/></p>
                </center>
				<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-clock ui-btn-inline" onClick="showCont('.ui-block-a','.ui-block-b')">Commandes</button>
				<button class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-calendar ui-btn-inline" onClick="showCont('.ui-block-b','.ui-block-a')">R&eacute;servations</button>
                <div class="responsive transpcont rounded shadow">
                    <div class="ui-block-a"><div class="ui-body">
						<div id="hist_cont"></div>
					</div></div>
                    <div class="ui-block-b"><div class="ui-body">
						<div id="book_cont"></div>
					</div></div>
                </div>
            </div>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="book_page">
		<!--
        <div data-role="header" data-position="fixed" class="header headerBook">
		</div>
		-->
        <div class="ui-content" role="main">
			<table width="100%" border="0" class="headerBook">
				<thead><tr><th width="50%"></th><th width="34%"></th><th width="16%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:500px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#homepanel" id="panel_poper" data-role="none" style="width:90%;">
						<img src="visuels/ico_menu.png" width="100%" style="max-width:175px;"/>
					</a>
				</td></tr>
				</tbody>
			</table>
			<div id="animBook" class="nyc">
				<p class="bottomText"><b>
					<br><br>Votre demande a &eacute;t&eacute; prise en compte, votre taxi prendra contact avec vous par t&eacute;l&eacute;phone ou sms.<br><br>Toute l&rsquo;&eacute;quipe Mon Appli Taxi vous remercie.
					<button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-back" onClick="goback('index.html')">Retour</button>
				</b></p>
				<img src="visuels/wifi-1.png" width="64%" id="wifiSteps" class="wifiSteps"/>
			</div>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="fleet_page">
		<!--
        <div data-role="header" data-position="fixed" data-fullscreen="true">
			<button onClick="goback('index.html')" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-power"><p style="font-size:16px"><b>Retour</b></p></button>
        </div>
		-->
        <div class="ui-content" id="fleet_map" role="main">
        </div>
        <div data-role="footer" id="footer_map" data-position="fixed" data-fullscreen="true">
            <center>
                <span class="cabNum" style="font-size:24px; color:#FC0;"></span>
				<button onClick="goback('index.html')" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-power"><p style="font-size:16px"><b>Retour</b></p></button>
            </center>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="follow_open">
        <div class="ui-content" id="follow_map_open" role="main">
        </div>
        <div data-role="footer" id="footer_map" data-position="fixed" data-fullscreen="true">
            <center><p>
                Les positions sont actualis&eacute;es toutes les 10 secondes.
				<button onClick="goback('index.html')" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-power"><p style="font-size:16px"><b>Arr&ecirc;ter</b></p></button>
            </p></center>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="follow">
		<!--
        <div data-role="header" data-position="fixed" data-fullscreen="true">
            <button onClick="goback('index.html')" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-power"><p style="font-size:16px"><b>Arr&ecirc;ter</b></p></button>
        </div>
		-->
        <div class="ui-content" id="follow_map" role="main">
        </div>
        <div data-role="footer" id="footer_map" data-position="fixed" data-fullscreen="true">
            <center><p><strong>
            	Vous ne pouvez suivre un taxi que 30 minutes avant le RDV.<br>
                Les positions sont actualis&eacute;es toutes les 30 secondes.
				<button onClick="goback('index.html')" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-power"><p style="font-size:16px"><b>Arr&ecirc;ter</b></p></button>
            </strong></p></center>
        </div>
    </div>
    <div data-role="page" data-theme="c" id="rate_page">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="14%"></th><th width="36%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#history" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-back"><p style="font-size:16px"><b>Retour</b></p></a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <div style="display:block;" id="monTaxiRate">
            	<center>
					<div id="urate" style="font-weight:bold;color: #FC0;"></div>
                </center>
                <div class="ui-bar-a ui-corner-all ui-shadow" style="padding:1em; display:block;">
                    Accueil :
                    <div class="rating" data-rating-max="5"></div><div class="cleaner"></div>
                    Tarif : 
                    <div class="rating2" data-rating-max="5"></div><div class="cleaner"></div>
                    Propret&eacute; / Vehicule : 
                    <div class="rating3" data-rating-max="5"></div><div class="cleaner"></div>
                    Conduite / itin&eacute;raire : 
                    <div class="rating4" data-rating-max="5"></div><div class="spacer"></div>
                </div>
				<textarea id="comRate" class="comRate" maxlength="512" placeholder="Commentaires"></textarea>
                <center><div id="rateBack"></div></center>
                <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" onClick="rating()">Envoyer</button>
            </div>
            <div style="display:block;" id="leTaxiRate">
            	<center>
					<div id="urate2" style="font-weight:bold;color: #FC0;"></div>
                </center>
                <div class="ui-bar-a ui-corner-all ui-shadow" style="padding:1em; display:block;">
                    Note :
                    <div class="rating5" id="rating5" data-rating-max="5"></div><div class="spacer"></div>
                </div>
				<div id="leComRateCont">
					<!-- <textarea id="leComRate" class="leComRate" maxlength="512" placeholder="Commentaires"></textarea> -->
					<select id="leComRate" class="leComRate"> 
						<option value="" selected>Raisons possibles</option>
						<option value="ko">Refus de service</option>
						<option value="payment">Probl&egrave;me de paiement (moyen de paiement, rendu de monnaie...)</option>
						<option value="cleanliness">Probl&egrave;me de propret&eacute; (v&eacute;hicule sale, odeur de tabac...)</option>
						<option value="route">Probl&egrave;me de trajet (d&eacute;tours...)</option>
						<option value="courtesy">Probl&egrave;me (politesse, radio, conduite...)</option>
					</select>
				</div>
                <center><div id="leRateBack"></div></center>
                <button class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" onClick="ratingOpen()">Envoyer</button>
            </div>
        </div>
    </div>
	<div data-role="page" data-theme="c" id="modbook">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="14%"></th><th width="36%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#history" class="ui-btn ui-btn-icon-left ui-corner-all ui-shadow ui-icon-back"><p style="font-size:16px"><b>Retour</b></p></a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <center>
            <div style="margin-top:1em; display:block;">
                <!-- <h1 class="hostname">Commander un taxi</h1> -->
                <table width="100%" border="0">
                	<thead><tr><th width="90%"></th><th width="10%"></th></tr></thead>
                    <tbody>
                	<tr><td>
                        <input type="text" id="addressInput2" data-clear-btn="true" size="40" placeholder="Adresse RDV" width="90%"/>
                    </td><td align="center">
						<img src="visuels/ico_geolocalisation.png" width="100%" class="cursor" onClick="locateMe()" style="max-width:40px;"/>
                    </td></tr>
                	<tr><td>
                        <input type="text" id="Accurate2" data-clear-btn="true" class="mustHave" size="32" placeholder="Nom *"/>
                    </td><td align="center">
						<img src="visuels/ico_modif.png" width="100%" class="cursor" onClick="getContact()" style="max-width:45px;"/>
                    </td></tr>
                	<tr><td>
                        <input type="tel" id="cellular2" data-clear-btn="true" class="mustHave" size="20" placeholder="Tel *"/>
                    </tbody>
                </table>
                <!-- <p style="font-size:small;"><em>*</em> Ces informations sont obligatoires</p> -->
                <p class="expends"><b>D&eacute;tails</b><br><img src="visuels/dots.png" width="100%" style="max-width:1200px;"/></p>
                <div id="details">
                    <label for="howMany">Nombre de passagers :</label>
                    <input name="howMany" id="howMany2" min="1" max="8" value="1" data-theme="c" data-show-value="true" data-popup-enabled="true" type="range">
                    <select id="CarType2"> 
                        <option value="Berline" selected>Vehicule</option>
                        <option value="Berline">Berline</option>
                        <option value="Break">Break</option>
                        <option value="Van">Monospace</option>
                    </select>
                    <select id="Pay2"> 
                        <option value="0" selected>CB</option>
                        <option value="0">Non</option>
                        <option value="1">Oui</option>
                    </select>
                    <textarea id="coms2" placeholder="Commentaires"></textarea>
                </div>
                <p id="datelabel"><b>Date et heure du RDV :</b></p>
                <input type="text" id="date2" placeholder="Date" data-clear-btn="true" data-inline="true" value=""/>
                <!-- 
                <span style="display:inline-block;width: 48%;">
                    <input type="date" id="date2" placeholder="Date" data-clear-btn="true" data-inline="true" value=""/>
                </span>
                <span style="display:inline-block;width: 48%;">
                    <input type="time" id="when2" placeholder="Heure" data-clear-btn="true" data-inline="true" value=""/>
                </span>
                -->
                <p>&nbsp;</p>
                <input type="hidden" id="modId" size="20" value=""/>
                <input type="hidden" id="modDep" size="2" value=""/>
				<div id="resmod"></div>
                <button onClick="bookingMod()" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-clock" id="bookingMod">Modifier la r&eacute;servation</button>
            </div>
            </center>
        </div>
    </div>
    <div data-role="page" data-theme="c"  id="prices">
        <div data-role="header" data-position="fixed" class="header">
			<table width="100%" border="0" class="header_cont">
				<thead><tr><th width="50%"></th><th width="34%"></th><th width="16%"></th></tr></thead>
				<tbody>
				<tr><td>
					<img src="visuels/header.png" width="100%" style="max-width:512px;"/>
				</td><td>
					<p>&nbsp;</p>
				</td><td align="center">
					<a href="#homepanel" id="panel_poper" data-role="none" style="width:90%;">
						<img src="visuels/ico_menu.png" width="100%" style="max-width:175px;"/>
					</a>
				</td></tr>
				</tbody>
			</table>
		</div>
        <div class="ui-content" role="main">
            <center>
            <div style="margin-top:1em; display:block;">
                <table width="100%" border="0">
                	<thead><tr><th width="90%"></th><th width="10%"></th></tr></thead>
                    <tbody>
                	<tr><td>
                        <input type="text" id="addressInputPrices" data-clear-btn="true" size="40" placeholder="Adresse RDV" width="90%" style="min-height:3em;"/>
                    </td><td align="center">
						<img src="visuels/ico_geolocalisation.png" width="100%" class="cursor" onClick="locateMe()" style="max-width:40px;"/>
                        <!-- <button onClick="locateMe()" class="ui-btn ui-btn-c ui-icon-location ui-shadow-icon ui-btn-icon-notext ui-corner-all"></button> -->
                    </td></tr>
                	<tr><td>
                        <input type="text" id="DestAddressPrices" data-clear-btn="true" class="mustHave" size="32" placeholder="Destination *" style="min-height:3em;"/>
                    </td><td align="center">
						&nbsp;
                    </td></tr>
                    </tbody>
                </table>
                <button id="validPrices" onClick="getPrices()" class="ui-btn ui-btn-c ui-shadow ui-corner-all ui-btn-icon-left ui-icon-check">Obtenir une estimation</button>
				<div id="pricesCont" class="transpcont rounded shadow"></div>
				<!-- 
                <div data-role="popup" data-theme="c" id="pricesPop" data-dismissible="true">
 					<a href="#prices" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Fermer</a>
                   <div data-theme="c" data-role="header">
                        <p style="font-size:21px;text-align:center;"><b>
                            Tarification
                        </b></p>
                    </div>
                    <div class="ui-content" role="main">
						<div id="pricesPopCont"></div>
                    </div>
                </div>
				-->
            </div>
            </center>
        </div>
    </div>
	</body>
</html>